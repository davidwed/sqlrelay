#!/bin/sh
# Copyright (c) 1999-2000 David Muse
# See the file COPYING for more information

prefix=@prefix@
tmpdir=@localstatedir@/sqlrelay/tmp

KILLARG=""
if ( test -n "$2" ); then
	KILLARG="-$2"
fi

echo "Killing the following processes:"

CYGWIN="@CYGWIN@"
PS="@PS@"
if ( test "$PS" = "ps\ aux" ); then

	ps aux | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop

	for times in 1 2
	do
		for i in `ps aux | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop | awk '{print $2}'`
		do
			kill $KILLARG $i
		done
		sleep 1
	done

	if ( test -n "`ps aux | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop`" ); then
		echo "Processes still alive:"
		ps aux | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop
	else
		echo "All processes killed."
	fi
else
	ps -efal | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop

	for times in 1 2
	do
		if ( test -n "$CYGWIN" )
		then
			# cygwin's listing isn't long enough to grep for $1
			for i in `ps -efal | grep sqlr- | grep -v grep | grep -v sqlr-stop | awk '{print $2}'`
			do
				kill $KILLARG $i
			done
			sleep 1
		else
			for i in `ps -efal | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop | awk '{print $4}'`
			do
				kill $KILLARG $i
			done
		fi
	done

	if ( test -n "`ps -efal | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop`" ); then
		echo "Processes still alive:"
		ps -efal | grep sqlr- | grep " $1" | grep -v grep | grep -v sqlr-stop
	else
		echo "All processes killed."
	fi
	
fi

# clean up tmp files
if ( test -n "$1" ); then
	rm -f ${tmpdir}/pids/sqlr-listener-$1
	rm -f ${tmpdir}/sockets/$1
	rm -f ${tmpdir}/ipc/$1-*
	rm -f ${tmpdir}/ipc/$1
else
	rm -f ${tmpdir}/pids/*
	rm -f ${tmpdir}/sockets/*
	rm -f ${tmpdir}/ipc/*
fi
