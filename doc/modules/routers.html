<html>
<head>
	<title>Router Modules</title>
	<link rel="stylesheet" href="../css/styles.css">
</head>
<body>
<h1>Router Modules</h1>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#available">Available Modules</a></li>
  <li><a href="#custom">Custom Modules</a></li>
</ul>

<hr/>

<a name="introduction"/><h2>Introduction</h2>

<p>When used in conjunction with the dbase="router" parameter, router modules allow the SQL Relay server to route queries to one database or another based on various conditions.</p>

<p>The <i>routers</i> section of the sqlrelay.conf file indicates which router modules to load and what parameters to use when executing them.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ... <font color="#009900">dbase</font><font color="#990000">=</font><font color="#FF0000">"router"</font> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;routers&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^drop "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^create "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^insert "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^update "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^delete "</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">".*"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
		<b><font color="#0000FF">&lt;/routers&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;connections&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/connections&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>The <i>module</i> attribute specifies which module to load.</p>

<p>Module configurations may have attributes and/or nested tags.  How these elements are interpreted is module-specific.</p>

<p>Currently, all router modules have an <i>enabled</i> parameter, allowing the module to be temporarily disabled.  If enabled="no" is configured, then the module is disabled.  If set to any other value, or omitted, then the module is enabled.</p>

<p>Router modules can be "stacked".  Multiple modules may be loaded and multiple instances of the same type of module, with different configurations, may also be loaded.</p>

<p>In fact, the example above shows a stacked configuration.  The first instance of the router module sends DDL/DML queries to a "master" database and the second instance of the router module sends all other queries to a "slave" database.</p>

<p>At startup, the SQL Relay server creates instances of the specified router modules and initializes them.  When the client sends a query to the SQL Relay server, the server consults each router module, in the order that they were specified in the config file.  Each module applies its routing rules to determine which connection to run the query on.  If a module returns a connection then the remaining modules are ignored.  If the query makes it through all modules without being routed to a particular connection, then the query is ignored.</p>

<a name="available"/><h2>Available Modules</h2>

<p>Currently, the following router modules are available:</p>

<ul>
  <li><b>regex</b></li>
  <li><b>userlist</b></li>
  <li><b>clientiplist</b></li>
</ul>

<h3>regex</h3>

<p>The <b>regex</b> module routes queries by matching them against regular expressions.</p>

<p>An example configuration follows.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ... <font color="#009900">dbase</font><font color="#990000">=</font><font color="#FF0000">"router"</font> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;routers&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^drop "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^create "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^insert "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^update "</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^delete "</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">".*"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
		<b><font color="#0000FF">&lt;/routers&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;connections&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/connections&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>In this example DDL/DML queries are routed to the connectionid "master", and all other queries are routed to the connectionid "slave".</p>

<p>The <b>string</b> parameter for the "master" connection refers to a separate instance of SQL Relay which maintains connections to the master database.  The <b>string</b> parameter for the "slave" connection refers to a separate instance of SQL Relay which maintains connections to the slave databases.</p>

<p>This example is explained in greater detail in the SQL Relay Configuration Guide, in the section on <a href="../admin/configguide.html#router">Master-Slave Query Routing</a>.</p>

<p>See <a href="../admin/router.html">Query Routing</a> for more information about query routing in general.</p>

<h3>userlist</h3>

<p>The <b>userlist</b> module routes queries by matching the user that ran the query against a list of users.</p>

<p>An example configuration follows.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ... <font color="#009900">dbase</font><font color="#990000">=</font><font color="#FF0000">"router"</font> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;routers&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"userlist"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;user</font></b> <font color="#009900">user</font><font color="#990000">=</font><font color="#FF0000">"master"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"userlist"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;user</font></b> <font color="#009900">user</font><font color="#990000">=</font><font color="#FF0000">"*"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
		<b><font color="#0000FF">&lt;/routers&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;connections&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/connections&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>In this example queries run by user named "master" are routed to the connectionid "master", and queries run by any other user are routed to the connectionid "slave".</p>

<p>The <b>string</b> parameter for the "master" connection refers to a separate instance of SQL Relay which maintains connections to the master database.  The <b>string</b> parameter for the "slave" connection refers to a separate instance of SQL Relay which maintains connections to the slave databases.</p>

<p>A similar example is explained in greater detail in the SQL Relay Configuration Guide, in the section on <a href="../admin/configguide.html#router">Master-Slave Query Routing</a>.</p>

<p>See <a href="../admin/router.html">Query Routing</a> for more information about query routing in general.</p>

<h3>clientiplist</h3>

<p>The <b>clientiplist</b> module routes queries by matching the client that ran the query against a list of IP addresses.</p>

<p>An example configuration follows.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ... <font color="#009900">dbase</font><font color="#990000">=</font><font color="#FF0000">"router"</font> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;routers&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"clientiplist"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;client</font></b> <font color="#009900">ip</font><font color="#990000">=</font><font color="#FF0000">"192.0-168.*.213"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
			<b><font color="#0000FF">&lt;router</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"clientiplist"</font> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;client</font></b> <font color="#009900">ip</font><font color="#990000">=</font><font color="#FF0000">"*"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/router&gt;</font></b>
		<b><font color="#0000FF">&lt;/routers&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;connections&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"master"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;connection</font></b> <font color="#009900">connectionid</font><font color="#990000">=</font><font color="#FF0000">"slave"</font> <font color="#009900">string</font><font color="#990000">=</font><font color="#FF0000">"..."</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/connections&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>In this example queries run by clients at IP addresses 192.0-168.*.213 are routed to the connectionid "master", and queries run by clients at any other IP address are routed to the connectionid "slave".</p>

<p>Each octet of the <b>ip</b> parameter may be specfied as a number, a dash-separated range of numbers, or a * meaning "all possible values".</p>

<p>The <b>string</b> parameter for the "master" connection refers to a separate instance of SQL Relay which maintains connections to the master database.  The <b>string</b> parameter for the "slave" connection refers to a separate instance of SQL Relay which maintains connections to the slave databases.</p>

<p>A similar example is explained in greater detail in the SQL Relay Configuration Guide, in the section on <a href="../admin/configguide.html#router">Master-Slave Query Routing</a>.</p>

<p>See <a href="../admin/router.html">Query Routing</a> for more information about query routing in general.</p>

<a name="custom"/><h2>Custom Modules</h2>

<p>Custom modules may also be developed.</p>

<p>For more information, please contact David Muse at <a href="mailto:david.muse@firstworks.com">david.muse@firstworks.com</a>. <a target="_blank" href="http://sqlrelay.sourceforge.net/images/us.png"><img src="http://sqlrelay.sourceforge.net/images/us.png"/></a> <a target="_blank" href="http://sqlrelay.sourceforge.net/images/br.png"><img src="http://sqlrelay.sourceforge.net/images/br.png"/></a>
</p>

</body>
</html>
