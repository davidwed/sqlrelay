<html>
<head>
	<title>Router Modules</title>
	<link rel="stylesheet" href="../css/styles.css">
</head>
<body>
<h1>Router Modules</h1>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#available">Available Modules</a></li>
  <li><a href="#custom">Custom Modules</a></li>
</ul>

<hr/>

<a name="introduction""/><h2>Introduction</h2>

<p>Router modules allow the SQL Relay server ...</p>

<p>The <i>routers</i> section of the sqlrelay.conf file indicates which router modules to load and what parameters to use when executing them.</p>

<blockquote>
</blockquote>
<p>The <i>module</i> attribute specifies which module to load.</p>

<p>Module configurations may have attributes and/or nested tags.  How these elements are interpreted is module-specific.</p>

<p>Currently, all router modules have an <i>enabled</i> parameter, allowing the module to be temporarily disabled.  If enabled="no" is configured, then the module is disabled.  If set to any other value, or omitted, then the module is enabled.</p>

<p>Filter modules can be "stacked".  Multiple modules may be loaded and multiple instances of the same type of module, with different configurations, may also be loaded.</p>

<blockquote>
</blockquote>
<p>At startup, the SQL Relay server creates instances of the specified router modules and initializes them...</p>

<a name="available""/><h2>Available Modules</h2>

<p>Currently, the following filter modules are available:</p>

<ul>
  <li><b>regex</b></li>
  <li><b>userlist</b></li>
  <li><b>clientiplist</b></li>
</ul>

<h3>regex</h3>

<p>...</p>

<h3>userlist</h3>

<p>...</p>

<h3>clientiplist</h3>

<p>...</p>

<a name="custom""/><h3>Custom Modules</h3>

<p>You can create your own custom query connection router modules too.</p>

<p>SQL Relay provides a base class for connection router modules, called sqlrrouter, defined in the header file: sqlrserver.h</p>

<blockquote>
</blockquote>
<p>On non-Windows platforms, it's most likely installed in /usr/local/firstworks/include/sqlrelay if you built from source or /usr/include/sqlrelay if you installed a package.  On Windows platforms, it's most likely installed in C:\Program Files\Firstworks\include\sqlrelay.</p>

<p>The default implementaion of the constructor just sets the member variables <i>sqlrfs</i>, <i>parameters</i> and <i>debug</i> to the corresponding passed-in values.  <i>sqlrfs</i> is a pointer to an instance of the sqlrrouters class, which provides various helper methods.  <i>parameters</i> is a representation of the XML tag in the sqlrelay.conf file that loaded the module.  <i>debug</i> is just a flag, indicating whether debug is requested or not.  The module should consult this flat and print out some debug if it is true.</p>

<p>By default, the destructor does nothing.</p>

<p>run() does nothing by default and returns true, indicating that no error occurred.</p>

<p>A custom module module must contain a class that inherits from sqlrrouter, implements the necessary methods, and implements a function to return an instance of the class.</p>

<p>Lets say we want to create a custom router module that ...</p>

<p>We can create the file ...</p>

<blockquote>
</blockquote>
<p>Here, the ... class inherits from sqlrrouter.  The constructor just calls the parent constructor.  The run() method ...</p>

<p>Note the "new_sqlrrouter_...()" function which just allocates an instance of .... and returns it.  This function is essential to provide, and it is essential that it be named "new_sqlrrouter_modulename" and take sqlrrouters *, xmldomnode * and bool.  It is also essential that it be wrapped with an <i>extern "C"</i> clause to prevent it from being name-mangled by the compiler.</p>

<p>To build the module on a Linux or Unix system, run a command like:</p>

<blockquote>
  <pre>gcc -shared `sqlrserver-config --cflags` `rudiments-config --cflags` -o sqlrrouter_....so ....cpp `sqlrserver-config --libs` `rudiments-config --libs`
</pre>

</blockquote>
<p>This will create the file sqlrrouter_....so</p>

<p>On Mac OSX, run a command like:</p>

<blockquote>
  <pre>gcc -bundle `sqlrserver-config --cflags` `rudiments-config --cflags` -o sqlrrouter_....bundle ....cpp `sqlrserver-config --libs` `rudiments-config --libs`
</pre>

</blockquote>
<p>This will create the sqlrrouter_....bundle</p>

<p>On Windows, run commands like:</p>

<blockquote>
  <pre>cl /I"C:\Program Files\Firstworks\include" /c ....cpp
link -out:sqlrrouter_....dll /LIBPATH:"C:\Program Files\Firstworks\lib" libsqlrserver.lib librudiments.lib
</pre>

</blockquote>
<p>This will create the sqlrrouter_....dll</p>

<p>It is essential that the file be named: sqlrrouter_modulename.extension</p>

<p>To install the new module, copy it to the SQL Relay "modules" directory.  On non-Windows platforms, that is most likely /usr/local/firstworks/libexec/sqlrelay if you built from source, or /usr/libexec/sqlrelay if you installed a package.  On Windows platforms, that is most likely C:\Program Files\Firstworks\libexec\sqlrelay</p>

<p>To configure an instance of SQL Relay to use your module, you will need to update the sqlrelay.conf file to include a "routers" section:</p>

<blockquote>
</blockquote>
<p>The server will see the module="..." attribute in the sqlrelay.conf file, look in the "modules" directory for sqlrrouter_....extension, load it and and run the new_sqlrrouter_...() method to get an instance of the ... class and then run the various methods of that class.</p>

<p>This example module doesn't have any parameters, but if you create a module that does then you can access them via the the protected "parameters" member variable.  For example:</p>

<blockquote>
</blockquote>
<p>Refer to the Rudiments documentation for more info on the <a target="_blank" href="http://rudiments.sourceforge.net/rudiments/classes/html/classxmldomnode.html">xmldomnode class</a>.
</p>

</body>
</html>
