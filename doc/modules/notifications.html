<html>
<head>
	<title>Notification Modules</title>
	<link rel="stylesheet" href="../css/styles.css">
</head>
<body>
<h1>Notification Modules</h1>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#available">Available Modules</a></li>
  <li><a href="#custom">Custom Modules</a></li>
</ul>

<hr/>

<a name="introduction"/><h2>Introduction</h2>

<p>Notification modules allow the SQL Relay server programs to notify recipients when a specified set of events occur. </p>

<p>The <i>notifications</i> section of the sqlrelay.conf file indicates which notification modules to load and what parameters to use when executing them.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;notifications&gt;</font></b>
			<b><font color="#0000FF">&lt;notification</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"events"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;events&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"db_error"</font><b><font color="#0000FF">/&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"db_warning"</font><b><font color="#0000FF">/&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"filter_violation"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/events&gt;</font></b>
				<b><font color="#0000FF">&lt;recipients&gt;</font></b>
					<b><font color="#0000FF">&lt;recipient</font></b> <font color="#009900">address</font><font color="#990000">=</font><font color="#FF0000">"dev@firstworks.com"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/recipients&gt;</font></b>
			<b><font color="#0000FF">&lt;/notification&gt;</font></b>
		<b><font color="#0000FF">&lt;/notifications&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>The <i>module</i> attribute specifies which module to load.</p>

<p>Module configurations may have attributes and/or nested tags.  How these elements are interpreted is module-specific.</p>

<p>Currently, all notification modules have an <i>enabled</i> parameter, allowing the module to be temporarily disabled.  If enabled="no" is configured, then the module is disabled.  If set to any other value, or omitted, then the module is enabled.</p>

<p>Notification modules can be "stacked".  Multiple modules may be loaded and multiple instances of the same type of module, with different configurations, may also be loaded.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;notifications&gt;</font></b>
			<b><font color="#0000FF">&lt;notification</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"events"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;events&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"db_error"</font><b><font color="#0000FF">/&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"db_warning"</font><b><font color="#0000FF">/&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"filter_violation"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/events&gt;</font></b>
				<b><font color="#0000FF">&lt;recipients&gt;</font></b>
					<b><font color="#0000FF">&lt;recipient</font></b> <font color="#009900">address</font><font color="#990000">=</font><font color="#FF0000">"dev@firstworks.com"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/recipients&gt;</font></b>
			<b><font color="#0000FF">&lt;/notification&gt;</font></b>
			<b><font color="#0000FF">&lt;notification</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"events"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;events&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"integrity_violation"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/events&gt;</font></b>
				<b><font color="#0000FF">&lt;recipients&gt;</font></b>
					<b><font color="#0000FF">&lt;recipient</font></b> <font color="#009900">address</font><font color="#990000">=</font><font color="#FF0000">"dba@firstworks.com"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/recipients&gt;</font></b>
			<b><font color="#0000FF">&lt;/notification&gt;</font></b>
		<b><font color="#0000FF">&lt;/notifications&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>At startup, the SQL Relay server processes create instances of the specified notification modules and initializes them.  As events occur, the server passes the event and, optionally, a string of information about the event to each module, in the order that they were specified in the config file.  If a module is listening for that event, then it sends a notification to the specified recpients.</p>

<a name="available"/><h2>Available Modules</h2>

<p>Currently, the following standard notification modules are available:</p>

<ul>
  <li><b>events</b></li>
</ul>

<h3>events</h3>

<p>The <b>events</b> module listens for a specified set of events and notifies recipients when a one occurs.</p>

<p>An example configuration follows.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> ...<b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;notifications&gt;</font></b>
			<b><font color="#0000FF">&lt;notification</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"events"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;events&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"db_error"</font><b><font color="#0000FF">/&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"db_warning"</font><b><font color="#0000FF">/&gt;</font></b>
					<b><font color="#0000FF">&lt;event</font></b> <font color="#009900">event</font><font color="#990000">=</font><font color="#FF0000">"filter_violation"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/events&gt;</font></b>
				<b><font color="#0000FF">&lt;recipients&gt;</font></b>
					<b><font color="#0000FF">&lt;recipient</font></b> <font color="#009900">address</font><font color="#990000">=</font><font color="#FF0000">"dev@firstworks.com"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;/recipients&gt;</font></b>
			<b><font color="#0000FF">&lt;/notification&gt;</font></b>
		<b><font color="#0000FF">&lt;/notifications&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>In this example, the module sends notifications to <b>dev@firstworks.com</b> when one of the <b>db_error</b>, <b>db_warning</b>, or <b>filter_violation</b> events occurs.</p>

<p>The <b>events</b> tag defines the set of events to listen for.  Valid events are:</p>

<ul>
  <li><b>client_connected</b> - An SQL Relay client connected to the SQL Relay server.</li>
  <li><b>client_connection_refused</b> - An SQL Relay client attempted to connect to the SQL Relay server but the server refused the connection, usually because authentication failed.</li>
  <li><b>client_disconnected</b> - An SQL Relay client disconnected from the SQL Relay server.</li>
  <li><b>client_protocol_error</b> - The SQL Relay server didn't understand something that the SQL Relay client sent to it.</li>
  <li><b>db_login</b> - The SQL Relay server opened a connection to the database.</li>
  <li><b>db_logout</b> - The SQL Relay server closed a connection to the database.</li>
  <li><b>db_error</b> - A query generated an error.</li>
  <li><b>db_warning</b> - A query generated a warning.</li>
  <li><b>query</b> - A query was executed.</li>
  <li><b>filter_violation</b> - A <a href="filters.html">filter module</a> prevented a query from being executed.</li>
  <li><b>internal_error</b> - An internal error occurred.</li>
  <li><b>internal_warning</b> - An internal warning occurred.</li>
  <li><b>debug_message</b> - A debug message was generated.</li>
  <li><b>schedule_violation</b> - A <a href="schedules.html">schedule module</a> prevented a user from logging in to the SQL Relay server.</li>
  <li><b>integrity_violation</b> - A <a href="routers.html">router module</a> is in use and a transaction control query (begin, commit, rollback, autocommit on, or autocommit off) succeeded on some of the backends but failed on others.</li>
</ul>

<p>Any number of events may be specified.  Each event must be specified in its own <b>event</b> tag.  The event tag supports the following attributes:</p>

<ul>
  <li><b>event</b> - Required.  The event to listen for.</li>
</ul>

<p>Any number of recipients may also be specified.  Each recipient must be specified in its own <b>recipient</b> tag.  The recipient tag supports the following attributes:</p>

<ul>
  <li><b>address</b> - Required.  The address to send the notification message to.</li>
  <li><b>subject</b> - Optional.  The subject of the notification message.</li>
  <li><b>template</b> - Optional.  The filename of the template to use for the notification message.</li>
</ul>

<p>Currently, notifications may only be sent via email.</p>

<p>If the <b>subject</b> attribute is not provided, then SQL Relay uses a default subject of:</p>

<blockquote>
SQL Relay Notification: @event@
</blockquote>
<p>Where @event@ is replaced with the event that triggered the notification.</p>

<p>If the <b>template</b> attribute is not provided, then SQL Relay uses a default template of:</p>

<blockquote>
  <pre>SQL Relay Notification:

Event          : @event@
Event Info     : @eventinfo@
Date           : @datetime@
Host Name      : @hostname@
Instance       : @instance@
Process Id     : @pid@
Client Address : @clientaddr@
Client Info    : @clientinfo@
User           : @user@
Query          :

</pre>

</blockquote>
<p>In both subject lines and template files, the following substitutions can be made:</p>

<ul>
  <li><b>@event@</b> - The event that triggered the notification.</li>
  <li><b>@eventinfo@</b> - The text (if any) that accompanied the event.</li>
  <li><b>@datetime@</b> - The date/time that the event occurred.</li>
  <li><b>@hostname@</b> - The host name of the server hosting the SQL Relay instance that generated the event.</li>
  <li><b>@instance@</b> - The instance name of the SQL Relay instance that generated the event.</li>
  <li><b>@pid@</b> - The process id of the SQL Relay instance that generated the event.</li>
  <li><b>@clientaddr@</b> - The client address (if any) of the SQL Relay client that was connected when the event occurred.</li>
  <li><b>@clientinfo@</b> - The client info (if any) of the SQL Relay client that was connected when the event occurred.</li>
  <li><b>@user@</b> - The SQL Relay user (if any) that was logged in to the SQL Relay instance that generated the event.</li>
  <li><b>@query@</b> - The query (if any) that was running when the event occurred.</li>
</ul>

<p>On linux/unix systems, the <i>mail</i> program is used to send notifications.  Messages are sent using the following command:</p>

<blockquote>
mail -s <i>subject</i> <i>address</i> < <i>message</i>
</blockquote>
<p>Where <i>subject</i> is replaced with the subject, <i>address</i> is replaced with the recipient and <i>messagee</i> is replaced with the name of the temporary file that is used to store the message.</p>

<p>SQL Relay assumes that the <i>mail</i> program is installed, in the PATH of the user that SQL Relay runs as, and that mail delivery is configured on the host system.</p>

<p>On Windows systems the <i>blat</i> program is used to send notifications.  Messages are sent using the following command:</p>

<blockquote>
blat <i>message</i> -to <i>address</i> -subject <i>subject</i> -q
</blockquote>
<p>Where <i>subject</i> is replaced with the subject, <i>address</i> is replaced with the recipient and <i>message</i> is replaced with the name of the temporary file that is used to store the message.</p>

<p>SQL Relay assumes that the <i>blat</i> program is installed, in the PATH of the user that SQL Relay runs as, and that blat has been configured.  See <a target="_blank" href="http://www.blat.net">http://www.blat.net</a> to download and configure blat.</p>

<a name="custom"/><h2>Custom</h2>

<p>Custom modules may also be developed.</p>

<p>For more information, please contact David Muse at <a href="mailto:david.muse@firstworks.com">david.muse@firstworks.com</a>. <a target="_blank" href="http://sqlrelay.sourceforge.net/images/us.png"><img src="http://sqlrelay.sourceforge.net/images/us.png"/></a> <a target="_blank" href="http://sqlrelay.sourceforge.net/images/br.png"><img src="http://sqlrelay.sourceforge.net/images/br.png"/></a>
</p>

</body>
</html>
