<html>
<head>
	<title>Query Filter Modules</title>
	<link rel="stylesheet" href="../css/styles.css">
</head>
<body>
<h1>Query Filter Modules</h1>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#available">Available Modules</a></li>
  <li><a href="#custom">Custom Modules</a></li>
</ul>

<hr/>

<a name="introduction"/><h2>Introduction</h2>

<p>Query Filter modules allow the SQL Relay server programs to filter out queries, and not pass them along to the database.</p>

<p>The <i>filters</i> section of the sqlrelay.conf file indicates which filter modules to load and what parameters to use when executing them.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> <font color="#009900">id</font><font color="#990000">=</font><font color="#FF0000">"example"</font> ... <b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;filters&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">" [0-9]*=[0-9]*"</font> <font color="#009900">errornumbrer</font><font color="#990000">=</font><font color="#FF0000">"100"</font> <font color="#009900">error</font><font color="#990000">=</font><font color="#FF0000">"regex filter violation"</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/filters&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>The <i>module</i> attribute specifies which module to load.</p>

<p>Module configurations may have attributes and/or nested tags.  How these elements are interpreted is module-specific.</p>

<p>Currently, all filter modules have an <i>enabled</i> parameter, allowing the module to be temporarily disabled.  If enabled="no" is configured, then the module is disabled.  If set to any other value, or omitted, then the module is enabled.</p>

<p>Filter modules can be "stacked".  Multiple modules may be loaded and multiple instances of the same type of module, with different configurations, may also be loaded.</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> <font color="#009900">id</font><font color="#990000">=</font><font color="#FF0000">"example"</font> ... <b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;filters&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">" [0-9]*=[0-9]*"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^(create)"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^(drop)"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"string"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"hugetable"</font> <font color="#009900">ignorecase</font><font color="#990000">=</font><font color="#FF0000">"yes"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"string"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"badschema"</font> <font color="#009900">ignorecase</font><font color="#990000">=</font><font color="#FF0000">"yes"</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/filters&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>At startup, the SQL Relay server creates instances of the specified filter modules and initializes them.  When a query is run, the server passes the query to each module, in the order that they were specified in the config file.  If a module filters out the query, then it isn't passed along to the next module, nor is it sent to the database, and the client program is told that the query failed.</p>

<p>When using query filters, it is helpful to use the <i>normalize</i> query translation too:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@parts<font color="#990000">/</font>sqlrelay<font color="#990000">-</font>filter<font color="#990000">-</font>regex<font color="#990000">-</font>normalize<font color="#990000">.</font>conf@
</tt></pre>
</pre>

</blockquote>
<p>See <a href="translations.html">Query Translations</a> for more information.</p>

<a name="available"/><h2>Available Modules</h2>

<p>Currently, the following filter modules are available:</p>

<ul>
  <li><b>patterns</b></li>
  <li><b>regex</b></li>
  <li><b>string</b></li>
</ul>

<h3>patterns</h3>

<p>The patterns module matches the query against a specified set of patterns.  Each pattern may be a string, case-insensitive string, or regular expression.  Each pattern may also be matched against the entire query, only the parts of the query that are outside of quotes, or only the parts of the query that are contained within quotes.  If the query matches, then it is filtered out.</p>

<p>The list of patterns is given by a set of <b>pattern</b> child tags.  Each pattern tag may contain the following attributes.</p>

<ul>
  <li><b>pattern</b> - Required.  The pattern to match.</li>
  <li><b>type</b> - Optional.  Defaults to "string".  Valid values are "string", "cistring" (case insensitive string), and "regex" (regular expression).</li>
  <li><b>scope</b> - Optional.  Defaults to "query".  Valid values are "query" (attempt to match against the entire query), "outsidequotes" (only match parts of the query not surrounded by single-quotes), and "insidequotes" (only match parts of the query surrounded by single-quotes).</li>
  <li><b>errornumber</b> - Optional.  Defaults to 0.  The error number to return to the client if the query matches this filter.</li>
  <li><b>error</b> - Optional.  Defaults to an empty string.  The error string to return to the client if the query matches this filter.</li>
</ul>

<p>For example, with the following configuration...</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> <font color="#009900">id</font><font color="#990000">=</font><font color="#FF0000">"example"</font> ... <b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;filters&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"patterns"</font><b><font color="#0000FF">&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"^(drop|create)"</font> <font color="#009900">type</font><font color="#990000">=</font><font color="#FF0000">"regex"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"hugetable"</font> <font color="#009900">type</font><font color="#990000">=</font><font color="#FF0000">"cistring"</font> <font color="#009900">scope</font><font color="#990000">=</font><font color="#FF0000">"outsidequotes"</font><b><font color="#0000FF">/&gt;</font></b>
				<b><font color="#0000FF">&lt;pattern</font></b> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"badstring"</font> <font color="#009900">scope</font><font color="#990000">=</font><font color="#FF0000">"insidequotes"</font> <font color="#009900">errornumbrer</font><font color="#990000">=</font><font color="#FF0000">"100"</font> <font color="#009900">error</font><font color="#990000">=</font><font color="#FF0000">"pattern filter violation"</font><b><font color="#0000FF">/&gt;</font></b>
			<b><font color="#0000FF">&lt;/filter&gt;</font></b>
		<b><font color="#0000FF">&lt;/filters&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>These queries would be filtered out:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>drop table mytable
create <font color="#008080">table</font> <b><font color="#000000">mytable</font></b> <font color="#990000">(</font><font color="#008080">col1</font> <font color="#009900">int</font><font color="#990000">)</font>
select <font color="#990000">*</font> from HugeTable
select <font color="#990000">*</font> from badstringtable <font color="#008080">where</font> col1<font color="#990000">=</font><font color="#FF0000">'badstring'</font>

</tt></pre>
</pre>

</blockquote>
<p>But these queries would not be:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>insert into <font color="#008080">mytable</font> <b><font color="#000000">values</font></b> <font color="#990000">(</font><font color="#993399">1</font><font color="#990000">)</font>
select <font color="#990000">*</font> from goodtable
select <font color="#990000">*</font> from badstringtable <font color="#008080">where</font> col1<font color="#990000">=</font><font color="#FF0000">'goodstring'</font>

</tt></pre>
</pre>

</blockquote>
<h3>regex</h3>

<p>The regex module matches the query against a specified regular expression pattern.  If the query matches, then it is filtered out.  This module is useful if you need to do a quick match, without the complexity of the patterns module.</p>

<p>In addition to the module attribute, each filter tag may contain the following attributes.</p>

<ul>
  <li><b>pattern</b> - Required.  The pattern to match.</li>
  <li><b>errornumber</b> - Optional.  Defaults to 0.  The error number to return to the client if the query matches this filter.</li>
  <li><b>error</b> - Optional.  Defaults to an empty string.  The error string to return to the client if the query matches this filter.</li>
</ul>

<p>For example, with the following configuration:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> <font color="#009900">id</font><font color="#990000">=</font><font color="#FF0000">"example"</font> ... <b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;filters&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"regex"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">" [0-9]*=[0-9]*"</font> <font color="#009900">errornumbrer</font><font color="#990000">=</font><font color="#FF0000">"100"</font> <font color="#009900">error</font><font color="#990000">=</font><font color="#FF0000">"regex filter violation"</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/filters&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>This query would be filtered out:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>select <font color="#990000">*</font> from mytable <font color="#008080">where</font> column1<font color="#990000">=</font><font color="#993399">1</font> and <font color="#993399">1</font><font color="#990000">=</font><font color="#993399">1</font>

</tt></pre>
</pre>

</blockquote>
<p>But this query would not be:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>select <font color="#990000">*</font> from mytable <font color="#008080">where</font> column1<font color="#990000">=</font><font color="#993399">1</font>

</tt></pre>
</pre>

</blockquote>
<h3>string</h3>

<p>The string module matches the query against a specified string pattern.  If the query matches, then it is filtered out.  This module is useful if you need to do a quick match without the complexity of regular expressions or of the patterns module.</p>

<p>In addition to the module attribute, each filter tag may contain the following attributes.</p>

<ul>
  <li><b>pattern</b> - Required.  The pattern to match.</li>
  <li><b>ignorecase</b> - Optional.  Defaults to "no".  If set to "yes" then the comparison is case insensitive.</li>
  <li><b>errornumber</b> - Optional.  Defaults to 0.  The error number to return to the client if the query matches this filter.</li>
  <li><b>error</b> - Optional.  Defaults to an empty string.  The error string to return to the client if the query matches this filter.</li>
</ul>

<p>For example, with the following configuration:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">&lt;?xml</font></b> <font color="#009900">version</font><font color="#990000">=</font><font color="#FF0000">"1.0"</font><b><font color="#000080">?&gt;</font></b>
<b><font color="#0000FF">&lt;instances&gt;</font></b>
	...
	<b><font color="#0000FF">&lt;instance</font></b> <font color="#009900">id</font><font color="#990000">=</font><font color="#FF0000">"example"</font> ... <b><font color="#0000FF">&gt;</font></b>
		...
		<b><font color="#0000FF">&lt;filters&gt;</font></b>
			<b><font color="#0000FF">&lt;filter</font></b> <font color="#009900">module</font><font color="#990000">=</font><font color="#FF0000">"string"</font> <font color="#009900">pattern</font><font color="#990000">=</font><font color="#FF0000">"hugetable"</font> <font color="#009900">ignorecase</font><font color="#990000">=</font><font color="#FF0000">"yes"</font> <font color="#009900">errornumbrer</font><font color="#990000">=</font><font color="#FF0000">"100"</font> <font color="#009900">error</font><font color="#990000">=</font><font color="#FF0000">"string filter violation"</font><b><font color="#0000FF">/&gt;</font></b>
		<b><font color="#0000FF">&lt;/filters&gt;</font></b>
		...
	<b><font color="#0000FF">&lt;/instance&gt;</font></b>
	...
<b><font color="#0000FF">&lt;/instances&gt;</font></b>

</tt></pre>
</pre>

</blockquote>
<p>This query would be filtered out:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>select <font color="#990000">*</font> from hugetable

</tt></pre>
</pre>

</blockquote>
<p>But this query would not be:</p>

<blockquote>
  <pre><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>select <font color="#990000">*</font> from goodtable <font color="#008080">where</font> column1<font color="#990000">=</font><font color="#993399">1</font>

</tt></pre>
</pre>

</blockquote>
<a name="custom"/><h2>Custom Modules</h2>

<p>Custom modules may also be developed.</p>

<p>For more information, please contact David Muse at <a href="mailto:david.muse@firstworks.com">david.muse@firstworks.com</a>. <a target="_blank" href="http://sqlrelay.sourceforge.net/images/us.png"><img src="http://sqlrelay.sourceforge.net/images/us.png"/></a> <a target="_blank" href="http://sqlrelay.sourceforge.net/images/br.png"><img src="http://sqlrelay.sourceforge.net/images/br.png"/></a>
</p>

</body>
</html>
