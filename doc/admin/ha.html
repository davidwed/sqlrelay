<html>
<head>
<title>firstworks   SQL Relay - High Availability</title>
<link href="../css/styles.css" rel="stylesheet">
</head>
<body>

<br><span class="heading1">High Availability</span><br>

<ul>
<li><a href="#backendloadbalancing">Distributing Load Over a Pool of Database Servers</a></li>
<li><a href="#backendfailover">Database Server Failover</a></li>
<li><a href="#frontendloadbalancing">Distributing Load Over a Pool of SQL Relay Servers</a></li>
<li><a href="#frontendfailover">SQL Relay Server Failover</a></li>
</ul>

<br>
<a name="backendloadbalancing"></a>
<span class="heading1">Distributing Load Over a Pool of Database Servers</span><br>

<p>There are probably a dozen commercial and Open Source Load Balancers
available today.  They are often implemented differently, and some have
unique features, but they all provide a single IP address for a pool of servers
and distribute incoming connections over the pool.</p>

<p>It's possible to set up a pool of database servers behind a Load Balancer.
Database clusters such as Oracle RAC come with their own built-in
load-balancer.  SQL Relay should work just fine with these systems.  Just
configure the instance of SQL Relay to connect to the IP address of the pool or
cluster and the Load Balancer will distribute the connections over the pool of
servers.</p>

<p>If you don't have a Load Balancer or would rather not use one, SQL Relay can
still distribute load over a pool of database servers.  In effect, SQL Relay is
a very specialized Load Balancer.  An instance of SQL Relay can be configured
to maintain connections to more than one database server and distribute client
sessions over the pool of servers it's connected to.</p>

<p>Note that SQL Relay distributes client sessions, not individual queries.
When a client connects to the SQL Relay listener daemon, it will be assigned to
one of the database servers in the pool, and as long as it remains connected,
all of its queries will be run against the same database server.  If the
client disconnects and reconnects, it may be assigned to a different database
server the next time around.</p>

<p>To configure an instance of SQL Relay to connect to a set of database
servers, you have to define multiple connection tags, as follows:</p>

<blockquote>
<pre>
<font color="#0000ff">&lt;?</font><font color="#2e8b57"><b>xml</b></font><font color="#2e8b57"><b> </b></font><font color="#2e8b57"><b>version</b></font>=<font color="#ff00ff">&quot;1.0&quot;</font><font color="#0000ff">?&gt;</font>
<font color="#008b8b">&lt;!</font><font color="#a52a2a"><b>DOCTYPE</b></font> instances <font color="#a52a2a"><b>SYSTEM</b></font> <font color="#ff00ff">&quot;sqlrelay.dtd&quot;</font><font color="#008b8b">&gt;</font>

<font color="#008b8b">&lt;</font><font color="#008b8b">instances</font><font color="#008b8b">&gt;</font>

        <font color="#008b8b">&lt;</font><font color="#008b8b">instance</font><font color="#008b8b"> </font><font color="#2e8b57"><b>id</b></font>=<font color="#ff00ff">&quot;example&quot;</font> <font color="#2e8b57"><b>dbase</b></font>=<font color="#ff00ff">&quot;oracle&quot;</font><font color="#008b8b"> <font color="#2e8b57"><b>connections</b></font>=<font color="#ff00ff">&quot;15&quot;</font><font color="#008b8b"><font color="#008b8b">&gt;</font>
                <font color="#008b8b">&lt;</font><font color="#008b8b">users</font><font color="#008b8b">&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">user</font><font color="#008b8b"> </font><font color="#2e8b57"><b>user</b></font>=<font color="#ff00ff">&quot;user1&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>password</b></font>=<font color="#ff00ff">&quot;password1&quot;</font><font color="#008b8b">/&gt;</font>
                <font color="#008b8b">&lt;/users&gt;</font>
                <font color="#008b8b">&lt;</font><font color="#008b8b">connections</font><font color="#008b8b">&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">connection</font><font color="#008b8b"> </font><font color="#2e8b57"><b>connectionid</b></font>=<font color="#ff00ff">&quot;DB1&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>string</b></font>=<font color="#ff00ff">&quot;user=exampleuser1;password=examplepassword1;oracle_sid=EXAMPLE1;&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>metric</b></font>=<font color="#ff00ff">&quot;1&quot;</font><font color="#008b8b">/&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">connection</font><font color="#008b8b"> </font><font color="#2e8b57"><b>connectionid</b></font>=<font color="#ff00ff">&quot;DB2&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>string</b></font>=<font color="#ff00ff">&quot;user=exampleuser2;password=examplepassword2;oracle_sid=EXAMPLE2;&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>metric</b></font>=<font color="#ff00ff">&quot;1&quot;</font><font color="#008b8b">/&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">connection</font><font color="#008b8b"> </font><font color="#2e8b57"><b>connectionid</b></font>=<font color="#ff00ff">&quot;DB3&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>string</b></font>=<font color="#ff00ff">&quot;user=exampleuser3;password=examplepassword3;oracle_sid=EXAMPLE3;&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>metric</b></font>=<font color="#ff00ff">&quot;1&quot;</font><font color="#008b8b">/&gt;</font>
                <font color="#008b8b">&lt;/connections&gt;</font>
        <font color="#008b8b">&lt;/instance&gt;</font>

<font color="#008b8b">&lt;/instances&gt;</font>
</pre>
</blockquote>

<p>In this example, SQL Relay will maintain 15 persistent database connections.
Since this instance is configured to connect to 3 different database servers,
SQL Relay will maintain 5 persistent connections to each server.</p>

<p>The <b>metric</b> attribute may be used to alter the distribution of 
connections over the databases in the pool.  Lets say that the server running
DB1 and DB2 are old machines, but the server running DB3 is brand new and can
handle twice as many connections as DB1 or DB2.  Assigning a metric of 1 to DB1
and DB2 and 2 to DB3 will cause twice as many connections to be started to
DB3 than either DB1 or DB2, making it twice as likely that a client will use
DB3 than either DB1 or DB2.  In this example, only 15 connections will be
started, but 7 or 8 will be started against DB3 and 3 or 4 will be started
against each of DB1 and DB2.</p>

<p>For instance:</p>

<blockquote>
<pre>
<font color="#0000ff">&lt;?</font><font color="#2e8b57"><b>xml</b></font><font color="#2e8b57"><b> </b></font><font color="#2e8b57"><b>version</b></font>=<font color="#ff00ff">&quot;1.0&quot;</font><font color="#0000ff">?&gt;</font>
<font color="#008b8b">&lt;!</font><font color="#a52a2a"><b>DOCTYPE</b></font> instances <font color="#a52a2a"><b>SYSTEM</b></font> <font color="#ff00ff">&quot;sqlrelay.dtd&quot;</font><font color="#008b8b">&gt;</font>

<font color="#008b8b">&lt;</font><font color="#008b8b">instances</font><font color="#008b8b">&gt;</font>

        <font color="#008b8b">&lt;</font><font color="#008b8b">instance</font><font color="#008b8b"> </font><font color="#2e8b57"><b>id</b></font>=<font color="#ff00ff">&quot;example&quot;</font> <font color="#2e8b57"><b>dbase</b></font>=<font color="#ff00ff">&quot;oracle&quot;</font><font color="#008b8b"> <font color="#2e8b57"><b>connections</b></font>=<font color="#ff00ff">&quot;15&quot;</font><font color="#008b8b"><font color="#008b8b">&gt;</font>
                <font color="#008b8b">&lt;</font><font color="#008b8b">users</font><font color="#008b8b">&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">user</font><font color="#008b8b"> </font><font color="#2e8b57"><b>user</b></font>=<font color="#ff00ff">&quot;user1&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>password</b></font>=<font color="#ff00ff">&quot;password1&quot;</font><font color="#008b8b">/&gt;</font>
                <font color="#008b8b">&lt;/users&gt;</font>
                <font color="#008b8b">&lt;</font><font color="#008b8b">connections</font><font color="#008b8b">&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">connection</font><font color="#008b8b"> </font><font color="#2e8b57"><b>connectionid</b></font>=<font color="#ff00ff">&quot;DB1&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>string</b></font>=<font color="#ff00ff">&quot;user=exampleuser1;password=examplepassword1;oracle_sid=EXAMPLE1;&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>metric</b></font>=<font color="#ff00ff">&quot;1&quot;</font><font color="#008b8b">/&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">connection</font><font color="#008b8b"> </font><font color="#2e8b57"><b>connectionid</b></font>=<font color="#ff00ff">&quot;DB2&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>string</b></font>=<font color="#ff00ff">&quot;user=exampleuser2;password=examplepassword2;oracle_sid=EXAMPLE2;&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>metric</b></font>=<font color="#ff00ff">&quot;1&quot;</font><font color="#008b8b">/&gt;</font>
                        <font color="#008b8b">&lt;</font><font color="#008b8b">connection</font><font color="#008b8b"> </font><font color="#2e8b57"><b>connectionid</b></font>=<font color="#ff00ff">&quot;DB3&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>string</b></font>=<font color="#ff00ff">&quot;user=exampleuser3;password=examplepassword3;oracle_sid=EXAMPLE3;&quot;</font><font color="#008b8b"> </font><font color="#2e8b57"><b>metric</b></font>=<font color="#ff00ff">&quot;2&quot;</font><font color="#008b8b">/&gt;</font>
                <font color="#008b8b">&lt;/connections&gt;</font>
        <font color="#008b8b">&lt;/instance&gt;</font>

<font color="#008b8b">&lt;/instances&gt;</font>
</pre>
</blockquote>

<br>
<a name="backendfailover"></a>
<span class="heading1">Database Server Failover</span><br>

<p>If an SQL Relay notices that the database server has gone down then it will
log out all connections to that server and loop, attempting to reestablish
them.  While the database server is down, client sessions will be distributed
over the servers that are still up.  When the database server comes back up, it
will be available again.</p>

<p>If the database servers are load balanced (eg. Oracle RAC) then
<b>behindloadbalancer="yes"</b> should be set in the connection tag to enable
some behaviors that greatly improve performance in this environment.</p>

<br>
<a name="frontendloadbalancing"></a>
<span class="heading1">Distributing Load Over a Pool of SQL Relay Servers</span><br>

<p>If your pool of application or web servers is sufficiently large, you might
want to set up a pool of SQL Relay servers between them and the database.</p>

<p>You can use a load balancer to make a pool of SQL Relay servers appear to be a single server or just set up a pool of SQL Relay servers and distribute client connections over them using <a href="http://en.wikipedia.org/wiki/Round-robin_DNS">Round Robin DNS</a>.</p>

<br>
<a name="frontendfailover"></a>
<span class="heading1">SQL Relay Server Failover</span><br>

<p>Failover between SQL Relay servers can be implemented using
<a href="http://en.wikipedia.org/wiki/Round-robin_DNS">Round Robin DNS</a>
or a load balancer.</p>

<p>With Round Robin DNS, when the SQL Relay client looks up the IP address of
the host, it actually gets back a list of all of the IP addresses in the pool.  
It tries to connect to the first address in the list.  If that fails, it tries
the next address, then the next, etc.  Eventually, it will either succeed in
connecting to one of the servers or run out of addresses and fail.</p>

<p>For example, this client is configured to connect to "sqlrserver".  If
"sqlrserver" resolves to a pool of addresses, then the client will attempt to
connect to each address that "sqlrserver" resolves to before giving up.</p>

<blockquote>
<pre>
sqlrconnection  sqlrcon(<font color="#ff00ff">&quot;sqlrserver&quot;</font>,<font color="#ff00ff">9000</font>,<font color="#ff00ff">NULL</font>,<font color="#ff00ff">&quot;sqlruser&quot;</font>,<font color="#ff00ff">&quot;sqlrpass&quot;</font>,<font color="#ff00ff">0</font>,<font color="#ff00ff">1</font>);
</pre>
</blockquote>

<p>The client can also be configured to try to connect to the same host
multiple times.  If the host name resolves to the IP address of a load balanced
pool of SQL Relay servers, then the client will attempt to log into the pool
over and over.</p>

<p>For example, this client is configured to log into the pool that the
hostname "sqlrserver" resolves to 10 times with a 1 second pause between each
try.</p>

<blockquote>
<pre>
sqlrconnection  sqlrcon(<font color="#ff00ff">&quot;sqlrserver&quot;</font>,<font color="#ff00ff">9000</font>,<font color="#ff00ff">NULL</font>,<font color="#ff00ff">&quot;sqlruser&quot;</font>,<font color="#ff00ff">&quot;sqlrpass&quot;</font>,<font color="#ff00ff">1</font>,<font color="#ff00ff">10</font>);
</pre>
</blockquote>

<p>The number of seconds between tries can be set to any number, including 0.
The total number of tries can be set to any number as well.  Setting it to
0 will cause the client to retry forever.</p>

</body>
</html>
