<h1>Oracle TLS/SSL Encryption With Self-Signed Certificates</h1>

<h3>Introduction</h3>

<p>This tutorial walks through enabling TLS/SSL encryption between an application and Oracle database, including basic encryption, certificate validation, distinguished name validation, and mutual authentication.</p>

<p>Self-signed certificates, generated by Oracle-provided tools, are used throughout.
Assumptions</p>

<p>The following assumptions are made:</p>

<ul>
  <li>An Oracle database is running on a linux server named db.firstworks.com.</li>
  <li>The database was installed by the oracle user.</li>
  <li>The database contains an instance named ora1 which is accessible using scott/tiger credentials.</li>
  <li>An application which accesses the database is installed on a linux server named app.firstworks.com.</li>
  <li>Oracle Instant Client is the only Oracle software installed on app.firstworks.com.</li>
  <li>It is possible to scp from db.firstworks.com to root@app.firstworks.com.</li>
  <li>It is possible to scp from app.firstworks.com to oracle@db.firstworks.com.</li>
</ul>

<br/><h3>Basic Encryption</h3>

<p>First, we will configure basic TLS/SSL encryption of the communications between the database and application server.</p>

<h4>Database Server Configuration</h4>

<p>Log in to the database server as the oracle user and create a wallet:</p>

<pre>orapki wallet create -wallet /u01/app/oracle/wallet -auto_login -pwd Passw0rd
</pre>

<p>The orapki options above do the following things:</p>

<ul>
  <li>-wallet specifies the path for the wallet.</li>
  <ul>
    <li>A wallet is just a directory with some files under it.</li>
    <li>If you need to delete a wallet, just delete the directory.</li>
  </ul>

  <li>-auto_login indicates that the wallet will be used for logins.</li>
  <ul>
    <li>There is also an alternative -auto_login_local option that locks the wallet down to the local machine. If the wallet is copied or moved to a different machine then attempts to use it will fail.</li>
    <li>These options can also be omitted, but it's not clear what a wallet created without one of them can be used for.</li>
  </ul>

  <li>-pwd specifies a password for the wallet.</li>
  <ul>
    <li>This password must be supplied to modify the wallet, but is not required to use the wallet. It may be used by any user with permissions to read its files.</li>
    <li>If the -pwd option is omitted then the user will be prompted for the password on the command line.</li>
    <li>Passwords must contain 8 characters, and must contain at least 1 number.</li>
    <li>Obviously a more secure password than Passw0rd should be used.</li>
  </ul>

</ul>

<p>Next, create a self-signed certificate:</p>

<pre>orapki wallet add -wallet /u01/app/oracle/wallet -dn CN=db.firstworks.com \
-keysize 2048 -self_signed -validity 3650 -pwd Passw0rd
</pre>

<p>This command actually does several things:</p>

<ul>
  <li>Creates a 2048-bit private key, which is stored in the wallet (and cannot be exported using Oracle-provided tools).</li>
  <li>Uses the private key to create a certificate request certificate request for distinguished name CN=db.firstworks.com, which is also stored in the wallet.</li>
  <li>Uses the certificate request to create a self-signed root certificate which is valid for 10 years (3650 days).</li>
  <li>Stores the certificate as a Trusted Certificate.</li>
  <li>Also stores the certificate as a User Certificate.</li>
</ul>

<p>You can display contents of the wallet as follows:</p>

<pre>orapki wallet display -wallet /u01/app/oracle/wallet
</pre>

<p>You should see CN=db.firstworks.com as both a User Certificate and Trusted Certificate.</p>

<p>Next, configure the database instance to use the wallet.</p>

<p>Edit $ORACLE_HOME/network/admin/sqlnet.ora and append these lines:</p>

<pre>WALLET_LOCATION =
  (SOURCE =
    (METHOD = FILE)
    (METHOD_DATA =
      (DIRECTORY = /u01/app/oracle/wallet)
    )
  )

SQLNET.AUTHENTICATION_SERVICES = ALL
SSL_CLIENT_AUTHENTICATION = FALSE
SSL_CIPHER_SUITES = (SSL_RSA_WITH_AES_256_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA)
</pre>

<p>These lines:</p>

<ul>
  <li>Provide the path to the wallet.</li>
  <li>Enable "all" authentication services (including TLS/SSL), as opposed to only allowing database user/password authentication.</li>
  <li>Disables authentication of the peer's certificate. For now we just want to encrypt communications.</li>
  <li>Enables a set of cipher suites. The default is "none" so a set of ciphers has to be explicitly provided.</li>
</ul>

<p>Edit $ORACLE_HOME/network/admin/listener.ora and add these lines near the top:</p>

<pre>WALLET_LOCATION =
  (SOURCE =
    (METHOD = FILE)
    (METHOD_DATA =
      (DIRECTORY = /u01/app/oracle/wallet)
    )
  )

SSL_CLIENT_AUTHENTICATION = FALSE
</pre>

<p>These lines do the same things that they do in sqlnet.ora. It's not clear why they have to be present in both files.</p>

<p>Also, edit $ORACLE_HOME/network/admin/listener.ora and update the LISTENER definition, adding an entry for the TCPS protocol on port 2484:</p>

<pre>LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = db.firstworks.com)(PORT = 1521))
      (ADDRESS = (PROTOCOL = TCPS)(HOST = db.firstworks.com)(PORT = 2484))
    )
  )
</pre>

<p>Now, bounce the listener:</p>

<pre>lsnrctl stop
lsnrctl start
</pre>

<p>That's all on the database server.</p>

<h4>Application Server Configuration</h4>

<p>Oracle clients don't create ephemeral keys, so on the application server, a wallet must also be created and populated with a User Certificate for the application.</p>

<p>Fortunately, this is relatively straightforward.</p>

<p>Log in to the database server as the oracle user, and...</p>

<ul>
  <li>Create a wallet in the local directory.</li>
  <li>Create a self-signed certificate for the distinguished name CN=app.firstworks.com.</li>
  <li>Tar up the local wallet.</li>
  <li>Copy it to the application server.</li>
  <li>Clean up.</li>
</ul>

<pre>orapki wallet create -wallet ./wallet -auto_login -pwd Passw0rd
orapki wallet add -wallet ./wallet -dn CN=app.firstworks.com \
-keysize 2048 -self_signed -validity 3650 -pwd Passw0rd
tar cf wallet.tar wallet
scp wallet.tar root@app.firstworks.com:
rm -r wallet wallet.tar
</pre>

<p>Log in to the application server as root, and...</p>

<ul>
  <li>Create a directory to serve as the ORACLE_HOME, with network/admin subdirectories.</li>
  <li>Extract the wallet into the ORACLE_HOME.</li>
  <li>Fix permissions.</li>
  <li>Clean up.</li>
</ul>

<pre>mkdir -p /var/oraclehome
mkdir -p /var/oraclehome/network/admin
tar xf ~/wallet.tar
chmod 755 wallet
chmod 644 wallet/*
rm ~/wallet.tar
</pre>

<p>Create /var/oraclehome/network/admin/sqlnet.ora with the following contents:</p>

<pre>WALLET_LOCATION =
   (SOURCE =
     (METHOD = FILE)
     (METHOD_DATA =
       (DIRECTORY = /u01/app/oracle/wallet)
     )
   )

SQLNET.AUTHENTICATION_SERVICES = ALL
SSL_CLIENT_AUTHENTICATION = FALSE
SSL_CIPHER_SUITES = (SSL_RSA_WITH_AES_256_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA)
</pre>

<p>Create /var/oraclehome/network/admin/tnsnames.ora with the following contents:</p>

<pre>ora1=
(DESCRIPTION =
        (ADDRESS =
                (PROTOCOL = TCPS)
                (HOST = db.firstworks.com)
                (PORT = 2484)
        )
        (CONNECT_DATA =
                (SERVER = DEDICATED)
                (SERVICE_NAME = ora1)
        )
)
</pre>

<p>Note that PROTOCOL = TPCS and PORT = 2484 instead of TCP/1521.</p>

<p>That's all on the application server.</p>

<h4>Testing With SQLPlus</h4>

<p>Connect to the database from the application server using sqlplus as follows:</p>

<pre>ORACLE_HOME=/var/oraclehome sqlplus scott/tiger@ora1
</pre>

<p>You can verify that the connection is TLS/SSL-secured by running:</p>

<pre>select sys_context('USERENV','network_protocol') from dual;

SYS_CONTEXT('USERENV','NETWORK_PROTOCOL')
--------------------------------------------------------------------------------
tcps
</pre>

<p>If the connection fails, then it may fail for one of these common, but also very cryptic errors:</p>

<ul>
  <li>ORA-12514: TNS:listener does not currently know of service requested in connect descriptor</li>
  <ul>
    <li>The listener isn't ready.</li>
    <li>It can take a while. Try again in a minute or two.</li>
  </ul>

  <li>ORA-28864: SSL connection closed gracefully</li>
  <ul>
    <li>The wallet on the database server was created without the -auto_login option.</li>
    <li>Remove the wallet, re-create the wallet with the -auto_login option, and bounce the listener.</li>
  </ul>

  <li>ORA-29106: Cannot import PKSC #12 wallet</li>
  <ul>
    <li>The application server's wallet was created with the -auto_login_local option.</li>
    <li>Remove the wallet, re-create the wallet with the -auto_login option instead of -auto_login_local, and move the new wallet to the application server.</li>
  </ul>

  <li>ORA-29024: Certificate validation failure</li>
  <ul>
    <li>You accidentally omitted or mispelled SSL_CLIENT_AUTHENTICATION = FALSE in sqlnet.ora, on the application server.</li>
    <li>Update sqlnet.ora on the application server with SSL_CLIENT_AUTHENTICATION = FALSE</li>
  </ul>

  <li>ORA-28860: Fatal SSL error</li>
  <ul>
    <li>You accidentally omitted or mispelled SSL_CLIENT_AUTHENTICATION = FALSE in sqlnet.ora and/or listener.ora, on the database server.</li>
    <li>Update sqlnet.ora and/or listener.ora on the database server with SSL_CLIENT_AUTHENTICATION = FALSE and bounce the listener.</li>
  </ul>

</ul>

<h4>Updating Your Application</h4>

<p>To get your application to use the new configuration:</p>

<p>You must set the environment variable ORACLE_HOME to /var/oraclehome, either system-wide, in the app's startup script, or in the app's config file.</p>

<p>You must update your application to use the SID "ora1" defined in the tnsnames.ora files, rather than the full database connection string. This is typically done in the app's config file, or sometimes in app code itself. For some apps, you have to set the environment variable ORACLE_SID, either system-wide, in the app's startup script, or in the app's config file.</p>

<h3>Adding Database Certificate Validation</h3>

<p>So far, we have encrypted communications between the application and the database, but we can make the application more secure by validating the database server's certificate.</p>

<p>The basic steps are:</p>

<ul>
  <li>Extract the database server's certificate.</li>
  <li>Add it to the application server's wallet.</li>
  <li>Set SSL_CLIENT_AUTHENTICATION = TRUE on the application server.</li>
</ul>

<p>Conceptually, this isn't very complex, but lack of orapki on the application server makes the process take a lot of unintuitive steps.</p>

<p>Log in to the database server as the oracle user, and export the database server's certificate.</p>

<pre>orapki wallet export -wallet /u01/app/oracle/wallet -dn CN=db.firstworks.com -cert db.crt -pwd Passw0rd
</pre>

<p>Log in to the application server as root, and...</p>

<ul>
  <li>Tar up the wallet.</li>
  <li>Copy it to the database server.</li>
  <li>Clean up.</li>
</ul>

<pre>cd /var/oraclehome
tar cf wallet.tar wallet
scp wallet.tar oracle@db.firstworks.com:
rm wallet.tar
</pre>

<p>Log in to the database server as the oracle user, and...</p>

<ul>
  <li>Extract the wallet locally.</li>
  <li>Add the database server's certificate as a Trusted Certificate to the local wallet.</li>
  <li>Tar up the local wallet.</li>
  <li>Copy it to the application server.</li>
  <li>Clean up.</li>
</ul>

<pre>tar xf wallet.tar
rm wallet.tar
orapki wallet add -wallet ./wallet -trusted_cert -cert db.crt -pwd Passw0rd
tar cf wallet.tar wallet
scp wallet.tar root@app.firstworks.com:
rm -r wallet wallet.tar
rm db.crt
</pre>

<p>Log in to the application server as root, and...</p>

<ul>
  <li>Remove the old wallet.</li>
  <li>Extract the updated wallet.</li>
  <li>Fix permissions.</li>
  <li>Clean up.</li>
</ul>

<pre>cd /var/oraclehome
rm -r wallet
tar xf ~/wallet.tar
chmod 755 wallet
chmod 644 wallet/*
rm ~/wallet.tar
</pre>

<p>Reconfigure the application server to validate the database's certificate against the set of Trusted Certificates in the wallet by enabling SSL_CLIENT_AUTHENTICATION. Edit /var/oraclehome/network/admin/sqlnet.ora and set:</p>

<pre>SSL_CLIENT_AUTHENTICATION = TRUE
</pre>

<p>The parameter name SSL_CLIENT_AUTHENTICATION is a bit of a misnomer, since we're using it to authenticate the database server's certificate. It should probably be called SSL_PEER_AUTHENTICATION.</p>

<p>Test the configuration using sqlplus:</p>

<pre>ORACLE_HOME=/var/oraclehome sqlplus scott/tiger@ora1
</pre>

<p>If the connection fails, then it will likely fail with:</p>

<ul>
  <li>ORA-29024: Certificate validation failure</li>
  <ul>
    <li>SSL_CLIENT_AUTHENTICATION = TRUE may be misspelled.</li>
    <li>Some wallet-update or wallet-transfer step failed or was skipped.</li>
    <li>In either case, just try again.</li>
  </ul>

</ul>

<h3>Adding Database Certificate Distinguished Name Validation</h3>

<p>So far, we are encrypting communications between the application and the database and validating the database server's certificate, but we can also make the application more secure by validating the distinguished name in the database server's certificate.</p>

<p>Log in to the application server as root.</p>

<p>Edit /var/oraclehome/network/admin/sqlnet.ora, and add the line:</p>

<pre>SSL_SERVER_DN_MATCH = TRUE
</pre>

<p>Edit /var/oraclehome/network/admin/tnsnames.ora, and add a SECURITY section to the ora1 entry as follows:</p>

<pre>ora1=
(DESCRIPTION =
        (ADDRESS =
                (PROTOCOL = TCPS)
                (HOST = db.firstworks.com)
                (PORT = 2484)
        )
        (CONNECT_DATA =
                (SERVER = DEDICATED)
                (SERVICE_NAME = ora1)
        )
 (SECURITY =
  (SSL_SERVER_CERT_DN = "CN=db.firstworks.com")
 )
)
</pre>

<p>Then you can test the configuration using sqlplus:</p>

<pre>ORACLE_HOME=/var/oraclehome sqlplus scott/tiger@ora1
</pre>

<p>If the connection fails, then it will likely fail with:</p>

<ul>
  <li>ORA-29003: SSL transport detected mismatched server certificate.</li>
  <ul>
    <li>The distinguished name in the database server's cert didn't match the SSL_SERVER_CERT_DN entry in the tnsnames.ora file.</li>
    <li>Verify the spelling of the distinguished name in the tnsnames.ora and certificate, and update the entry in the tnsnames.ora accordingly. Alternatively, you could delete both wallets, start completely over and make sure to spell the name correctly in the certificate.</li>
  </ul>

</ul>

<br/><h3>Adding Mutual Authentication</h3>

<p>Just as we configured the application server to validate the database's certificate, it is also possible to configure the database server to validate the application server's certificate.</p>

<p>The basic steps are:</p>

<ul>
  <li>Extract the application server's certificate.</li>
  <li>Add it to the database server's wallet.</li>
  <li>Set SSL_CLIENT_AUTHENTICATION = TRUE on the database server.</li>
  <li>Bounce the listener.</li>
</ul>

<p>Conceptually, this isn't very complex, but lack of orapki on the application server makes the process take several unintuitive steps.</p>

<p>Log in to the application server as root, and...</p>

<ul>
  <li>Tar up the wallet.</li>
  <li>Copy it to the database server.</li>
  <li>Clean up.</li>
</ul>

<pre>cd /var/oraclehome
tar cf wallet.tar wallet
scp wallet.tar oracle@db.firstworks.com:
rm wallet.tar
</pre>

<p>Log in to the database server as the oracle user, and...</p>

<ul>
  <li>Extract the wallet locally.</li>
  <li>Export the application server's certificate from the local wallet.</li>
  <li>Add the application server's certificate as a Trusted Certificate to the database server's wallet.</li>
  <li>Clean up.</li>
</ul>

<pre>tar xf wallet.tar
orapki wallet export -wallet ./wallet -dn CN=app.firstworks.com -cert app.crt -pwd Passw0rd
orapki wallet add -wallet /u01/app/oracle/wallet -trusted_cert -cert app.crt -pwd Passw0rd
rm -r wallet wallet.tar app.crt
</pre>

<p>Edit $ORACLE_HOME/network/admin/sqlnet.ora, and update the SSL_CLIENT_AUTHENTICATION parameter to:</p>

<pre>SSL_CLIENT_AUTHENTICATION = TRUE
</pre>

<p>Edit $ORACLE_HOME/network/admin/listener.ora, and update the SSL_CLIENT_AUTHENTICATION parameter to:</p>

<pre>SSL_CLIENT_AUTHENTICATION = TRUE
</pre>

<p>This line does the same thing that it does in sqlnet.ora. It's not clear why it has to be present in both files.</p>

<p>Bounce the listener:</p>

<pre>lsnrctl stop
lsnrctl start
</pre>

<p>Then you can test the configuration from the application server, using sqlplus:</p>

<pre>ORACLE_HOME=/var/oraclehome sqlplus scott/tiger@ora1
</pre>

<p>If the connection fails, then it will likely fail with:</p>

<ul>
  <li>ORA-12514: TNS:listener does not currently know of service requested in connect descriptor</li>
  <ul>
    <li>The listener isn't ready.</li>
    <li>It can take a while. Try again in a minute or two.</li>
  </ul>

  <li>ORA-28860: Fatal SSL error</li>
  <ul>
    <li>SSL_CLIENT_AUTHENTICATION = TRUE may be omitted or misspelled in sqlnet.ora and/or listener.ora.</li>
    <li>Some wallet-update or wallet-transfer step failed or was skipped.</li>
    <li>In either case, just try again and bounce the listener.</li>
  </ul>

</ul>

<p>There is no obvious way to validate the distinguished name in the application server's certificate. I suspect that this just isn't supported.</p>

