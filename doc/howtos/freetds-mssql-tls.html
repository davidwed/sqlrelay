<h1>TLS/SSL Encryption with MS SQL Server and FreeTDS</h1>

<h3>Introduction</h3>

<p>This tutorial walks through enabling TLS/SSL encryption between a FreeTDS application and an Microsoft SQL Server 2014 database, including basic encryption, certificate validation, and common name validation.</p>

<p>Unfortunately MS SQL Server doesn't support mutual authentication via TLS/SSL; that is, the database cannot validate the application's certficate and common name. This is just as well though, as there is also no obvious way to configure FreeTDS to use a private key and certificate on the client-side.</p>

<h3>Assumptions</h3>

<p>For the purposes of this tutorial, the following assumptions are made:</p>

<ul>
  <li>An MS SQL Server 2014 database is running on a Windows system named db.firstworks.com.</li>
  <li>The database contains an instance named EXAMPLEDB which is accessible using exampleuser/examplepass credentials.</li>
  <li>An application which accesses the database is installed on a linux server named app.firstworks.com and currently configured to access the database without encryption.</li>
  <li>The application uses FreeTDS to access the database.</li>
  <li>A private key and certificate for the database don't currently exist, but will be created, and will be named db.key and db.crt.</li>
  <li>A certificate chain for the certificate authority which will sign db.crt exists, named ca.pem.</li>
</ul>

<br/><h3>Basic Encryption</h3>

<p>First, we will configure basic TLS/SSL encryption of the communications between the database and application server.</p>

<h4>Database Server Configuration</h4>

<p>By default, MS SQL Server 2015 supports encryption, and enables it if the application so requests. We can configure the database to require encrypted connections, though, as follows.</p>

<ul>
  <li>Open the Start menu.</li>
  <li>Select the Microsoft SQL Server 2014 program group.</li>
  <li>Select the SQL Server Configuration Manager.</li>
  <li>Expand SQL Server Network Configuration.</li>
  <li>Right-Click Protocols for EXAMPLEDB and select Properties.</li>
  <li>Select the Flags Tab.</li>
  <li>Change Force Encryption to Yes.</li>
  <li>Click OK.</li>
  <li>Click OK.</li>
  <li>Exit the SQL Server Configuration Manager.</li>
</ul>

<p>Restart the database server.</p>

<ul>
  <li>Press Windows-key-R.</li>
  <li>Type "services.msc" and hit return.</li>
  <li>Scroll down to SQL Server (EXAMPLEDB) and select it.</li>
  <li>Click Restart the service.</li>
</ul>

<p>That's all on the database server.</p>

<h4>Application Server Configuration</h4>

<p>MS SQL Server speaks versions 7.0 - 7.4 of the TDS (Tabular Data Stream) protocol. Version 7.0 doesn't support encryption, but versions 7.1 and higher do.</p>

<p>FreeTDS requests encryption when it's configured to use TDS version 7.1 or higher. Just to be sure, though, we can also configure the connection to require encryption, rather than just request it.</p>

<p>Edit the FreeTDS configuration file (usually /etc/freetds.conf), find the server entry that you use to connect to the EXAMPLEDB, verify that the TDS version is set to 7.1 or higher, and add a line to require encryption, as follows:</p>

<pre>[EXAMPLEDB]
 host = db.firstworks.com
 port = 1433
 tds version = 7.3
 encryption = require
</pre>

<p>Note that in this example, "tds version" is set to 7.3. I have had trouble with 7.4 resulting in "Unexpected EOF from the server" errors. Your mileage may vary.</p>

<p>That's all on the application server.</p>

<h4>Testing With tsql</h4>

<p>Connect to the database from the application server using the FreeTDS-supplied tsql program as follows:</p>

<pre>tsql -S EXAMPLEDB -U exampleuser -P examplepass
</pre>

<p>Unfortunately there is no easy way to verify that the connection is encrypted. If you access the database as the "sa" user, then you can run:</p>

<pre>1> select encrypt_option from sys.dm_exec_connections where session_id = @@SPID
2> go
encrypt_option
TRUE
(1 row affected)
</pre>

<p>But non-admin users don't typically have access to sys.dm_exec_connections.</p>

<p>Another way to verify that the connection is encrypted is to run tsql with TDSDUMP enabled:</p>

<pre>TDSDUMP=stdout tsql -S EXAMPLEDB -U exampleuser -P examplepass
</pre>

<p>If you see lines in the output like:</p>

<pre>  REC[0x55a2216316b0]: Decrypted Packet[1] Application Data(23) with length: 421
</pre>

<p>then the connection is encrypted.</p>

<p>If the connection fails, it will most likely fail with:</p>

<ul>
  <li>Error 20017 (severity 9): Unexpected EOF from the server</li>
  <ul>
    <li>The server didn't like something about the protocol and hung up.</li>
    <li>Verify that you are using tds version 7.1 - 7.3 in your freetds.conf server entry.</li>
  </ul>

</ul>

<br/><h4>Updating Your Application</h4>

<p>Your application shouldn't actually require any changes. As long as it is configured to use the EXAMPLEDB server entry, all communications between it and the database will be encrypted.</p>

<h3>Adding Database Certificate Validation</h3>

<p>So far, we have encrypted communications between the application and the database, but we can make the application more secure by installing a certificate on the database server, and configuring the application to validate the certificate.</p>

<h4>Database Server Configuration</h4>

<p>The database server must have has host name "db" and primary DNS suffix "firstworks.com". But, Windows servers are commonly configured without a primary DNS suffix.</p>

<p>To set the primary DNS suffix:</p>

<ul>
  <li>Press Windows-key-R.</li>
  <li>Type "control panel" and hit return.</li>
  <li>Click System and Security.</li>
  <li>Click System.</li>
  <li>Under "Computer name, domain name, and workgroup settings", click Change settings.</li>
  <li>Next to "To rename this computer or change its domain or workgroup, click Change", click Change.</li>
  <li>Click More.</li>
  <li>Under "Primary DNS suffix of this computer" enter "firstworks.com".</li>
  <li>Click OK.</li>
  <li>Click OK.</li>
  <li>Click OK.</li>
  <li>Reboot the database server.</li>
</ul>

<br/><p>Generate the certificate for the database server.</p>

<p>The certificate can be generated by a well-known certificate authority, generated by an in-house certificate authority, or can even be self-signed.</p>

<p>In any case, MS SQL Server places some specific requirements on the certificate:</p>

<ul>
  <li>The common name MUST match the fully qualified domain name of the database server. In this case: db.firstworks.com.</li>
  <li>The Enhanced Key Usage property MUST include Server Authentication.</li>
  <ul>
    <li>In openssl terms, the extendedKeyUsage extension must include serverAuth in the extfile used to generate the certificate signing request.</li>
  </ul>

</ul>

<br/><p>Combine this certificate, its associated private key, and certificate for the certificate authority that signed it into a PKCS#12 certificate chain file named db.pfk.</p>

<p>There are various ways to do this, but with openssl you can run:</p>

<pre>PASSWORD="" openssl pkcs12 -export -passout env:PASSWORD -in db.crt -inkey db.key -certfile ca.crt -out db.pfx
</pre>

<p>When the pfk is created, it MUST be created with KeySpec set to AT_KEYEXCHANGE. Or, in openssl terms, the -keyext option must be used when creating the pfk file. Actually though, -keyext is the default, so just DON'T create the pfk file using -keysig.</p>

<p>The C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys folder often has the wrong permissions. Verify that both Administrators and Everyone have Full Control. If they don't, then give them both Full Control. You may get an error when you do this, indicating that permissions couldn't be changed on an individual file, but this seems safe to ignore.</p>

<p>Now that the prerequisites are taken care of...</p>

<p>Copy db.pfk to the database server, and install it in the Windows certificate store:</p>

<ul>
  <li>Press Windows-key-R.</li>
  <li>Type "mmc" and hit return.</li>
  <li>Click File.</li>
  <li>Click Add/Remove Snap-in.</li>
  <li>From Available snap-ins, double-click Certificates.</li>
  <li>Select Computer Account.</li>
  <li>Click Next.</li>
  <li>Select Local Computer.</li>
  <li>Click Finish.</li>
  <li>Click OK.</li>
  <li>Expand Certificates (Local Computer).</li>
  <li>Right-Click Personal.</li>
  <li>Click All Tasks.</li>
  <li>Click Import...</li>
  <li>Click Next.</li>
  <li>Click Browse.</li>
  <li>Select All Files *.* from the file-types pulldown.</li>
  <li>Select db.pfk</li>
  <li>Click OK.</li>
  <li>Enter a private key password, if your private key has one.</li>
  <li>Click Next.</li>
  <li>Click Next.</li>
  <li>Click Finish.</li>
  <li>Exit</li>
  <li>Don't save settings.</li>
</ul>

<p>Configure MS SQL Server to use the certificate.</p>

<ul>
  <li>Open the Start menu.</li>
  <li>Select the Microsoft SQL Server 2014 program group.</li>
  <li>Select the SQL Server Configuration Manager.</li>
  <li>Expand SQL Server Network Configuration.</li>
  <li>Right-Click Protocols for EXAMPLEDB and select Properties.</li>
  <li>Select the Certificates Tab.</li>
  <li>Select db.firstworks.com from the pulldown list.</li>
  <ul>
    <li>If db.firstworks.com is missing from the list, then either:</li>
    <ul>
      <li>The common name in the certificate is something other than "db.firstworks.com".</li>
      <ul>
        <li>The best solution is to generate a new certificate.</li>
      </ul>

      <li>The database server's host name is something other than "db".</li>
      <ul>
        <li>See instructions above for setting the host name.</li>
      </ul>

      <li>The database server's primary DNS suffix is something other than "firstworks.com".</li>
      <ul>
        <li>See instructions above for setting the primary DNS suffix.</li>
      </ul>

    </ul>

  </ul>

  <li>Click OK.</li>
  <li>Click OK.</li>
  <li>Exit the SQL Server Configuration Manager.</li>
</ul>

<p>Restart the database server.</p>

<ul>
  <li>Press Windows-key-R.</li>
  <li>Type "services.msc" and hit return.</li>
  <li>Scroll down to SQL Server (EXAMPLEDB) and select it.</li>
  <li>Click Restart the service.</li>
  <ul>
    <li>If the service fails to start, then either:</li>
    <ul>
      <li>The Enhanced Key Usage property of the certificate is missing or doesn't include Server Authentication.</li>
      <ul>
        <li>Generate a new certificate with the parameter set correctly.</li>
        <li>Replace the bad certificate.</li>
        <li>Restart SQL Server (EXAMPLEDB)</li>
      </ul>

      <li>C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys has the wrong permissions.</li>
      <ul>
        <li>See instructions above for setting the permissions.</li>
        <li>Restart SQL Server (EXAMPLEDB)</li>
      </ul>

    </ul>

  </ul>

  <li>Exit the Services manager.</li>
</ul>

<p>That's all on the database server.</p>

<h4>Application Server Configuration</h4>

<p>Configuring the application server is much simpler.</p>

<p>Copy ca.pem to the application server and install it in a convenient place, like /etc.</p>

<p>FreeTDS will validate the database's certificate if it is provided with a certificate chain to validate it against.</p>

<p>On the application server, edit the FreeTDS configuration file (usually /etc/freetds.conf), find the server entry that you use to connect to the EXAMPLEDB, and add a ca file line, as follows:</p>

<pre>[EXAMPLEDB]
 host = db.firstworks.com
 port = 1433
 tds version = 7.3
 encryption = require
 ca file = /etc/ca.pem
 check certificate hostname = no
</pre>

<p>Note that "check certificate hostname" is set to no. At this point, we're just validating that the database server is a host that we trust. We're not worried about whether it's the exact host we intend to be talking to.</p>

<p>That's all on the application server.</p>

<h4>Testing With tsql</h4>

<p>Connect to the database from the application server using the FreeTDS-supplied tsql program as follows:</p>

<pre>tsql -S EXAMPLEDB -U exampleuser -P examplepass
</pre>

<p>If the connection fails, it will most likely fail with:</p>

<pre>Error 20002 (severity 9): Adaptive Server connection failed
</pre>

<p>Which isn't very helpful. Running tsql with TDSDUMP enabled...</p>

<pre>TDSDUMP=stdout tsql -S EXAMPLEDB -U exampleuser -P examplepass
</pre>

<p>...may be slightly more revealing.</p>

<p>It may say:</p>

<pre>tls.c:484:handshake failed: Error in the certificate.
</pre>

<p>That usually means that the ca.pem's certificate authority didn't sign the database's certificate. Double-check it.</p>

<p>If it also says something like this:</p>

<pre>tls.c:368:Certificate hostname does not match
</pre>

<p>Then "check certificate hostname" is probably misspelled.</p>

<p>Adding Database Certificate Common Name Validation</p>

<p>So far, we are encrypting communications between the application and the database and validating the database server's certificate, but we can also make the application more secure by validating the common name in the database server's certificate.</p>

<p>This is actually pretty simple. In fact we had to do additional work to disable it earlier.</p>

<p>On the application server, modify /etc/freetds.conf and set "check certificate hostname" to yes.</p>

<pre>[EXAMPLEDB]
 host = db.firstworks.com
 port = 1433
 tds version = 7.3
 encryption = require
 ca file = /etc/ca.pem
 check certificate hostname = yes
</pre>

<p>Or, optionally just remove the parameter altogether, as checking the certificate's common name is the default behavior.</p>

<p>You can test the configuration using tsql:</p>

<pre>tsql -S EXAMPLEDB -U exampleuser -P examplepass
</pre>

<p>Again, it may fail with the not-so-helpful:</p>

<pre>Error 20002 (severity 9): Adaptive Server connection failed
</pre>

<p>Running tsql with TDSDUMP enabled...</p>

<pre>TDSDUMP=stdout tsql -S EXAMPLEDB -U exampleuser -P examplepass
</pre>

<p>...might be more revealing.</p>

<p>It may say:</p>

<pre>...
tls.c:368:Certificate hostname does not match
...
tls.c:484:handshake failed: Error in the certificate.
...
</pre>

<p>This means that the common name in the database's certificate didn't match the host parameter in the freetds.conf file.</p>

<ul>
  <li>Verify the common name in the freetds.conf file and in the database's certificate.</li>
  <ul>
    <li>If the host name in the freetds.conf file is wrong then change it and try again.</li>
    <li>If the common name in the certificate is wrong, then:</li>
    <ul>
      <li>Ideally the certificate should be regenerated and re-deployed.</li>
      <li>If that's not an option, then you can add a DNS entry (or /etc/hosts entry) for the name that is in the certificate, and update the freetds.conf file with that name.</li>
    </ul>

  </ul>

</ul>

