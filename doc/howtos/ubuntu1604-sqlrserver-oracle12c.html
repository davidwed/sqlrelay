<h1>Ubuntu 16.05 - SQL Relay Server + Oracle 12c</h1>

<p>This how-to walks through:</p>

<ul>
  <li>Installing an SQL Relay server on an Ubuntu 16.04 system</li>
  <li>Configuring a connection between the SQL Relay server and an Oracle database</li>
</ul>

<p>It assumes that two systems have been set up and configured as follows:</p>

<p><b>SQL Relay server</b></p>

<ul>
  <li>Ubuntu 16.04 Server operating system</li>
  <li>At least the following package sets were selected during installation:</li>
  <ul>
    <li>standard system utilities</li>
    <li>OpenSSH server</li>
  </ul>

  <li><i>apt upgrade</i> was run post-install</li>
  <li>A user with sudo privileges has ssh and scp/sftp access to the system</li>
</ul>

<p><b>Oracle database server</b></p>

<ul>
  <li>Any operating system that supports Oracle 10g or higher</li>
  <li>Oracle 10g or higher database is installed, accessible as:</li>
  <ul>
    <li>Hostname: <i>oracle</i></li>
    <li>Port: 1521</li>
    <li>SID/SERVICE_NAME: <i>ora1</i></li>
    <li>Username: <i>oracleuser</i></li>
    <li>Password: <i>oraclepassword</i></li>
  </ul>

</ul>

<br/><h3>Install Prerequisite Software</h3>

<p>ssh into the SQL Relay server and run the following command to install the prerequisite software packages:</p>

<pre>sudo apt install unzip g++ make libedit-dev libssl-dev libkrb5-dev libpcre3-dev libcurl4-openssl-dev libaio1
</pre>

<br/><h3>Install Oracle Instant Client</h3>

<p>Download Oracle Instant Client 12c as follows.</p>

<ul>
  <li>Navigate to <a target="_blank" href="https://oracle.com">the Oracle website</a>.</li>
  <li>Mouse-over the <i>Sign In</i> link at the top right of the page.</li>
  <li>If you don't already have an account, click <i>Create an account</i> and follow the instructions.</li>
  <li>If you have an account, click the <i>Sign In</i> box and enter your Username and Password.</li>
  <li>Navigate to <a target="_blank" href="http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html">Instant Client Downloads for Linux x86-64</a>.</li>
  <li>Click the radio box next to <i>Accept License Agreement</i>.</li>
  <li>Scroll down to the section labelled <i>Version 12.2.0.1.0</i> and download the following zip files from beneath that section:</li>
  <ul>
    <li>instantclient-basic-linux.x64-12.2.0.1.0.zip</li>
    <li>instantclient-sdk-linux.x64-12.2.0.1.0.zip</li>
  </ul>

</ul>

<p>scp/sftp the zip files to the SQL Relay server, ssh into the SQL Relay server, and install the the contents of the zip files as follows:</p>

<pre>unzip instantclient-basic-linux.x64-12.2.0.1.0.zip
unzip instantclient-sdk-linux.x64-12.2.0.1.0.zip
sudo mv instantclient_12_2 /opt
</pre>

<p>Create the file /etc/ld.so.conf.d/oracle.conf with the following contents:</p>

<pre>/opt/instantclient_12_2
</pre>

<p>Then run:</p>

<pre>sudo /sbin/ldconfig
</pre>

<br/><h3>Build and Install SQL Relay Server Software</h3>

<p>Download current .tar.gz files of SQL Relay and Rudiments from the <b>Source Distribution</b> section of <a target="_blank" href="http://sqlrelay.sourceforge.net/download.html">the SQL Relay Downloads page</a> and scp/sftp them to the SQL Relay server.</p>

<p>ssh into the SQL Relay server, and extract, build, and install the software as follows:</p>

<pre>tar xfz rudiments-*.tar.gz
cd rudiments-*
./configure
make
sudo make install
cd ..
tar xfz sqlrelay-*.tar.gz
cd sqlrelay-*
./configure
make
sudo make install
</pre>

<br/><h3>Update the Environment</h3>

<p>Create /etc/profile.d/firstworks.sh with the following contents:</p>

<pre>export PATH=$PATH:/usr/local/firstworks/bin
</pre>

<p>Update the sudo secure_path by running:</p>

<pre>sudo visudo
</pre>

<p>...and editing the secure_path line to include /usr/local/firstworks/bin and read as follows:</p>

<pre>Defaults        secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin:/usr/local/firstworks/bin"
</pre>

<p>(hit ctrl-X, followed by Y to save)</p>

<p>Create /etc/ld.so.conf.d/firstworks.conf with the following contents:</p>

<pre>/usr/local/firstworks/lib
</pre>

<p>Then run:</p>

<pre>sudo /sbin/ldconfig
</pre>

<p>Exit and ssh back in to apply the updates to the environment.</p>

<h3>Configure SQL Relay</h3>

<p>Create /usr/local/firstworks/etc/sqlrelay.conf.d/oracle.conf with the following contents:</p>

<pre>&lt;?xml version="1.0"?&gt;
&lt;instances&gt;
    &lt;instance id="sample" enabled="yes"&gt;
        &lt;users&gt;
            &lt;user user="sqlruser" password="sqlrpassword"/&gt;
        &lt;/users&gt;
        &lt;connections&gt;
            &lt;connection string="user=oracleuser;password=oraclepassword;oracle_sid=(DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = oracle)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = ora1)))"/&gt;
        &lt;/connections&gt;
    &lt;/instance&gt;
&lt;/instances&gt;
</pre>

<p>Configure more secure permissions on this file:</p>

<pre>sudo chown nobody /usr/local/firstworks/etc/sqlrelay.conf/oracle.conf
sudo chmod 640 /usr/local/firstworks/etc/sqlrelay.conf/oracle.conf
</pre>

<br/><h3>Start SQL Relay</h3>

<p>Start SQL Relay by running:</p>

<pre>sudo sqlr-start -id sample
</pre>

<p>It should respond with the following output:</p>

<pre>Starting listener:
  sqlr-listener -id sample -localstatedir /usr/local/firstworks/var/

Starting 5 connections to sample-0 :
  sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
  sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
  sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
  sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
  sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
</pre>

<p>There shouldn't be any errors or warnings, but if there are, then some typical problems and solutions include:</p>

<ul>
  <li>Permissions errors</li>
  <ul>
    <li>Verify that the file oracle.conf is owned by <i>nobody:root</i> and has -rw-r----- permissions.</li>
    <li>Verify that you used sudo when running sqlr-start</li>
  </ul>

  <li>A prerequisite package wasn't installed</li>
  <ul>
    <li>Rerun the apt command at the top of the tutorial</li>
  </ul>

  <li>/etc/ld.so.conf.d/oracle.conf doesn't include the correct path</li>
  <ul>
    <li>Update it with the correct path and run: sudo /sbin/ldconfig</li>
  </ul>

  <li>/etc/profile.d/firstworks.sh doesn't include the correct path</li>
  <ul>
    <li>Update it with the correct path and re-login</li>
  </ul>

  <li>/etc/ld.so.conf.d/firstworks.conf doesn't include the correct path</li>
  <ul>
    <li>Update it with the correct path and run: sudo /sbin/ldconfig</li>
  </ul>

  <li>secure_path in /etc/sudoers doesn't include the correct path</li>
  <ul>
    <li>Update it with the correct path using: sudo visudo</li>
  </ul>

  <li>The SERVICE_NAME is incorrect in the connection string sqlrelay.conf</li>
  <ul>
    <li>Update sqlrelay.conf with a valid SERVICE_NAME</li>
  </ul>

  <li>The user or password is incorrect in the connection string in sqlrelay.conf</li>
  <ul>
    <li>Update sqlrelay.conf with valid user or password</li>
  </ul>

  <li>The database hostname doesn't resolve to an IP address</li>
  <ul>
    <li>Add an entry in /etc/hosts with the hostname and IP address of the database</li>
    <li>Update your local DNS configuration with the hostname and IP address of the database</li>
    <li>Replace the database hostname in the connection string in sqlrelay.conf with the IP address of the database</li>
  </ul>

</ul>

<p>If you need to restart the SQL Relay server, run:</p>

<pre>sudo sqlr-stop
sudo sqlr-start -id sample
</pre>

<h3>Verify SQL Relay</h3>

<p>To verify that the SQL Relay processes are running, run:</p>

<pre>ps -efa | grep sqlr- | grep -v grep
</pre>

<p>It should respond with output like the following:</p>

<pre>nobody     1272      1  0 12:33 ?        00:00:00 sqlr-listener -id sample -localstatedir /usr/local/firstworks/var/
nobody     1273      1  0 12:33 ?        00:00:00 sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
nobody     1274      1  0 12:33 ?        00:00:00 sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
nobody     1275      1  0 12:33 ?        00:00:00 sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
nobody     1276      1  0 12:33 ?        00:00:00 sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
nobody     1277      1  0 12:33 ?        00:00:00 sqlr-connection -id sample -connectionid sample-0 -localstatedir /usr/local/firstworks/var/
</pre>

<p>There should be 1 sqlr-listener process and 5 sqlr-connection processes, all running as the user <i>nobody</i>.</p>

<p>To verify that you can log into the SQL Relay server and run queries, run the <i>sqlrsh</i> client as follows:</p>

<pre>sqlrsh -host localhost -user sqlruser -password sqlrpassword
</pre>

<p>It should respond with the following output and prompt:</p>

<pre>sqlrsh - Version 1.2.0
        Connected to: localhost:9000 as sqlruser

        type help; for help.

0>
</pre>

<p>Try a simple query:</p>

<pre>select 'hello world' from dual;
</pre>

<p>It should respond with the following output and prompt:</p>

<pre>'HELLOWORLD'
============
hello world

        Rows Returned   : 1
        Fields Returned : 1
        Elapsed Time    : 0.006065 sec

0>
</pre>

<p>There shouldn't be any errors or warnings, but if there are, then some typical problems and solutions include:</p>

<ul>
  <li>"Couldn't connect to the listener." - the SQL Relay server probably isn't running</li>
  <ul>
    <li>Restart the SQL Relay server</li>
  </ul>

  <li>"Authentication Error." - the user or password specified on the sqlrsh command line don't match the user or password in the user tag of the sqlrelay.conf file</li>
  <ul>
    <li>Specify the correct user or password on the sqlrsh command line</li>
    <li>Update the sqlrelay.conf file and restart SQL Relay</li>
  </ul>

  <li>"ORA-00942: table or view does not exist" - the table name <i>dual</i> was mispelled, perhaps as <i>dua1</i> (with the number <i>1</i> instead of the letter <i>l</i>)</li>
  <ul>
    <li>Spell the table name <i>dual</i> with the letter <i>l</i></li>
  </ul>

</ul>

<p>SQL Relay should also be configured to restart on reboot.  To verify this:</p>

<ul>
  <li>Reboot the server</li>
  <li>Log into it when it has finished rebooting</li>
  <li>Verify that the SQL Relay processes are running, as described above</li>
  <li>Verify that you run queries with the <i>sqlrsh</i> client as described above</li>
</ul>

<p>Congratulations!  If you made it to this point, the SQL Relay server is configured correctly.</p>

<h3>Uninstallation</h3>

<p>If, for some reason, you need to completely uninstall SQL Relay, then run the following commands from the directory that the source trees were extracted to:</p>

<pre>cd sqlrelay-*
sudo make uninstall
cd ../rudiments-*
sudo make uninstall
sudo rm -rf /usr/local/firstworks
</pre>

