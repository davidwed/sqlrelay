<h1> Windows - SQL Relay Server + TLS + .pfx + MS SQL Server</h1>

<p>This how-to walks through:</p>

<ul>
  <li>Installing an SQL Relay server on a Windows system</li>
  <li>Configuring a TLS-secured connection between the SQL Relay server and an MS SQL Server database with a .pfx file</li>
  <li>Configuring the SQL Relay server for TLS-secured communications with SQL Relay clients</li>
</ul>

<p>It assumes that two systems have been set up and configured as follows:</p>

<p><b>SQL Relay server</b></p>

<ul>
  <li>64-bit Windows 7 or higher operating system</li>
  <li>A user with Administrator privileges has console or Remote Desktop access to the system</li>
  <li>A browser is installed and configured to be able to access the web without significant restrictions</li>
  <li>The host name of the server is set to <i>sqlrserver</i></li>
  <li>The fully qualified domain name of the server is <i>sqlrserver.firstworks.com</i></li>
</ul>

<p><b>MS SQL Server database server</b></p>

<ul>
  <li>Any operating system that supports MS SQL Server 2012 or higher</li>
  <li>MS SQL Server 2012 or higher, accessible as:</li>
  <ul>
    <li>Hostname: <i>mssql</i></li>
    <li>Port: 1433</li>
    <li>SQL Server Authentication:</li>
    <ul>
      <li>Username: <i>mssqluser</i></li>
      <li>Password: <i>mssqlpassword</i></li>
    </ul>

  </ul>

</ul>

<p>This how-to also assumes that a certificate has been created to secure the SQL Relay server, which was signed by an Certificate Authority internal to the organization, rather than a well-known Certificate Authority, and:</p>

<ul>
  <li>The CA cert is available as ca.pfx</li>
  <li>The SQL Relay server certificate was created with the Common Name or a Subject Alternative Name set to <i>sqlrserver.firstworks.com</i></li>
  <li>A certificate store file sqlrelay.pfx has been created containing:</li>
  <ul>
    <li>The SQL Relay server certificate</li>
    <li>The private key</li>
    <li>The CA certificate</li>
  </ul>

</ul>

<h3>Install Rudiments and SQL Relay Packages</h3>

<p>Download current .zip files of the <b>SQL Relay Binary Distribution for Windows</b> from the <b>Binary Distributions</b> section of the <a target="_blank" href="http://sqlrelay.sourceforge.net/download.html">the SQL Relay Downloads page</a> to the SQL Relay server Desktop.</p>

<p>Extract and install the software as follows:</p>

<ul>
  <li>Right-click on sqlrelay-binary-distribution-1.2.0.zip and select Extract All...</li>
  <li>Click Extract</li>
  <li>Wait for extraction to finish and to pop up a window containing the extracted files</li>
  <li>Navigate to sqlrelay-binary-distribution-1.2.0\x64\rudiments</li>
  <li>Double-click setup</li>
  <li>If you get an Open File - Security Warning then click Run</li>
  <li>In the setup wizard...</li>
  <ul>
    <li>On the <b>Welcome to the Firstworks Rudiments (64-bit) Setup Wizard</b> screen, click Next</li>
    <li>On the <b>Select Installation Folder</b> screen, click Next</li>
    <li>On the <b>Confirm Installation</b> screen, click Next</li>
    <li>The <b>Installing Firstworks Rudiments (64-bit)</b> screen will show installation progress</li>
    <li>On the <b>Installation Complete</b> screen, click Close</li>
  </ul>

  <li>Navigate up and into sqlrelay-binary-distribution-1.2.0\x64\sqlrelay</li>
  <li>Double-click setup</li>
  <li>If you get an Open File - Security Warning then click Run</li>
  <li>In the setup wizard...</li>
  <ul>
    <li>On the <b>Welcome to the Firstworks SQL Relay (64-bit) Setup Wizard</b> screen, click Next</li>
    <li>On the <b>Select Installation Folder</b> screen, click Next</li>
    <li>On the <b>Confirm Installation</b> screen, click Next</li>
    <li>The <b>Installing Firstworks SQL Relay (64-bit)</b> screen will show installation progress</li>
    <li>On the <b>Installation Complete</b> screen, click Close</li>
  </ul>

  <li>Close the sqlrelay-binary-distribution-1.2.0 file manager window.</li>
</ul>

<p>It's now safe to trash the sqlrelay-binary-distribution-1.2.0 folder and zip.</p>

<h3>Configure an ODBC DSN</h3>

<p>SQL Relay will use ODBC to connect to the database.</p>

<p>To configure a DSN for a TLS-encrypted ODBC connection to MS SQL Server:</p>

<ul>
  <li>Press Windows-key-R</li>
  <li>Type <i>odbcad32</i> and hit return</li>
  <li>In the <b>ODBC Data Source Administrator</b></li>
  <ul>
    <li>Select the System DSN tab</li>
    <li>Click Add...</li>
    <li>Select SQL Server Native Client 11.0</li>
    <li>Click Finish</li>
    <li>In the <b>Create a New Data Source to SQL Server</b> dialog</li>
    <ul>
      <li>Enter <i>mssql</i> for Name</li>
      <li>Enter <i>mssql</i> for Server</li>
      <li>Click Next</li>
      <li>Click the radio button next to With SQL Server authentication...</li>
      <li>Enter <i>mssqluser</i> for Login ID</li>
      <li>Enter <i>mssqlpassword</i> for Password</li>
      <li>Click Next</li>
      <li>Click Next</li>
      <li>Check Use strong encryption for data</li>
      <li>Click Finish</li>
      <li>Click OK</li>
    </ul>

    <li>Click OK</li>
  </ul>

</ul>

<h3>Configure SQL Relay</h3>

<p>To configure SQL Relay:</p>

<ul>
  <li>Install sqlrelay.pfx as C:\Program Files\Firstworks\etc\sqlrelay.pfx</li>
  <li>Install ca.pfx as C:\Program Files\Firstworks\etc\ca.pfx</li>
  <li>Create the file C:\Program Files\Firstworks\etc\sqlrelay.conf.d\mssql.conf with the following contents:</li>
</ul>

<pre>&lt;?xml version="1.0"?&gt;
&lt;instances&gt;
    &lt;instance id="sample" dbase="odbc"
            tls="yes" tlscert="C:\\Program Files\\Firstworks\\etc\\sqlrelay.pfx"&gt;
        &lt;users&gt;
            &lt;user user="sqlruser" password="sqlrpassword"/&gt;
        &lt;/users&gt;
        &lt;connections&gt;
            &lt;connection string="dsn=mssql;user=mssqluser;password=mssqlpassword"/&gt;
        &lt;/connections&gt;
    &lt;/instance&gt;
&lt;/instances&gt;
</pre>

<h3>Start SQL Relay</h3>

<p>Start SQL Relay by running:</p>

<pre>sqlr-start -id sample
</pre>

<p>It should open a new window with the following output:</p>

<pre>Starting listener:
  sqlr-listener -id sample -localstatedir C:\Program Files\Firstworks\var\

Starting 5 connections to sample-0 :
  sqlr-connection -id sample -connectionid sample-0 -localstatedir C:\Program Files\Firstworks\var\
  sqlr-connection -id sample -connectionid sample-0 -localstatedir C:\Program Files\Firstworks\var\
  sqlr-connection -id sample -connectionid sample-0 -localstatedir C:\Program Files\Firstworks\var\
  sqlr-connection -id sample -connectionid sample-0 -localstatedir C:\Program Files\Firstworks\var\
  sqlr-connection -id sample -connectionid sample-0 -localstatedir C:\Program Files\Firstworks\var\
</pre>

<p>There shouldn't be any errors or warnings, but if there are, then there is probably a configuration problem of some kind.  Adjust mssql.conf or the ODBC DSN as appropriate.</p>

<p>If you need to restart the SQL Relay server, run:</p>

<pre>sqlr-stop
sqlr-start -id sample
</pre>

<h3>Verify SQL Relay</h3>

<p>To verify that the SQL Relay processes are running:</p>

<ul>
  <li>Press Windows-key-R</li>
  <li>Type <i>taskmgr</i> and hit return</li>
  <li>Select the Processes tab</li>
</ul>

<p>There should be 1 sqlr-listener process and 5 sqlr-connection processes.</p>

<p>To verify that you can log into the SQL Relay server and run queries, run the <i>sqlrsh</i> client as follows:</p>

<pre>sqlrsh -host localhost -user sqlruser -password sqlrpassword -tls -tlsverify ca+host -tlsca "C:\Program Files\Firstworks\etc\ca.pfx"
</pre>

<p>It should respond with the following output and prompt:</p>

<pre>sqlrsh - Version 1.2.0
        Connected to: localhost:9000 as sqlruser

        type help; for help.

0>
</pre>

<p>Try a simple query:</p>

<pre>select 'hello world';
</pre>

<p>It should respond with the following output and prompt:</p>

<pre>
============
hello world

        Rows Returned   : 1
        Fields Returned : 1
        Elapsed Time    : 0.006065 sec

0>
</pre>

<p>There shouldn't be any errors or warnings.</p>

<p>Congratulations!  If you made it to this point, the SQL Relay server is configured correctly.</p>

<h3>Uninstallation</h3>

<p>If, for some reason, you need to completely uninstall SQL Relay then:</p>

<ul>
  <li>Press Windows-key-R</li>
  <li>Enter <i>control panel</i> and hit return</li>
  <li>Click Uninstall a program</li>
  <li>Select Firstworks SQL Relay (64-bit) and click Uninstall</li>
  <li>Click Yes</li>
  <li>Wait for the Windows Installer dialog to finsh uninstalling the package</li>
  <li>Select Firstworks Rudiments (64-bit) and click Uninstall</li>
  <li>Click Yes</li>
  <li>Wait for the Windows Installer dialog to finsh uninstalling the package</li>
  <li>Close the Control Panel</li>
  <li>Open a Windows Explorer window</li>
  <li>Browse to C:\Program Files</li>
  <li>Right-click Firstworks and select Delete</li>
  <li>Click Yes</li>
  <li>Empty the Recycle Bin
</li>
</ul>

