<html>
<head>
<title>firstworks   SQL Relay Client API's</title>
<link href="css/styles.css" rel="stylesheet">
</head>
<body>

<span class="heading1">SQL Relay Client API's</span><br><br>

<p>The <b>SQL Relay</b> client API's are ultimately based on the C++ API and the
Rudiments library.  A more portable approach would be to implement the API 
natively in a language like Java, Python or Perl.  A more stripped down and
potentially higher performance version of the API could be written in any 
language.</p>

<p><b>SQL Relay</b> has always had an open-protocol by virtue of being 
open-source, but reverse-engineering it from the API code can be a daunting 
task.  If it were documented in plainer terms, it would be "more open".</p>

<p>Born of these motivations, the following pseudocode demonstrates the 
protocol and its capabilities.  This code should provide enough detail about 
the protocol to enable a developer to write his or her own API.</p>

<p>Note that this specification will likely change a bit as new features
are added to <b>SQL Relay</b>.</p>

<span class="heading2">Legend</span><br><br>
<ul>
  <li>Yellow: long - a 32 bit integer</li>
  <li>Red: short - a 16 bit integer</li>
  <li>Green: string - a series of 8 bit chars</li>
  <li>Blue: double - a 32 bit, double precision floating point number</li>
</ul>

<span class="heading2">Client/Listener Communication</span><br><br>

<ul>
  <li>Connect to the sqlr-listener using an inet or unix datagram socket</li>

  <li>Send:
    <table border="1">
    <tr><td bgcolor="yellow">length of user name</td></tr>
    <tr><td bgcolor="green">user name string</td></tr>
    <tr><td bgcolor="yellow">length of password</td></tr>
    <tr><td bgcolor="green">password string</td></tr>
    </table>
  </li>

  <li>Receive:
    <table border="1">
    <tr><td bgcolor="red">error status: 1 or 0</td></tr>
    </table>

    <ul>
      <li>If error status is 1
        <table border="1">
        <tr><td bgcolor="red">length of the error</td></tr>
        <tr><td bgcolor="green">error string</td></tr>
        </table>
      </li>
  
      <li>If error status is 0
        <table border="1">
        <tr><td bgcolor="red">whether to reconnect to the connection daemon or not</td></tr>
        </table>
        <ul>
          <li>If reconnect is 1
            <table border="1">
            <tr><td bgcolor="red">length of the inet port</td></tr>
            <tr><td bgcolor="green">unix port string</td></tr>
            <tr><td bgcolor="red">inet port</td></tr>
            </table>
          <ul>
            <li>Disconnect from listener</li>
          </ul>
          <li>If reconnect is 0 skip down to <a href="#send">Send</a> below.
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<span class="heading2">Client/Connection Communication</span><br><br>

<ul>
  <li>Connect to the sqlr-connection-"dbase" using the inet or unix datagram 
socket that you got from the listener</li>
  <a name="send"></a>
  <li>Send:
    <table border="1">
    <tr><td bgcolor="red">11 (sending authentication)</td></tr>
    <tr><td bgcolor="yellow">length of user name</td></tr>
    <tr><td bgcolor="green">user name string</td></tr>
    <tr><td bgcolor="yellow">length of password</td></tr>
    <tr><td bgcolor="green">password string</td></tr>
    </table>
  </li>
  <li>Receive:
    <table border="1">
    <tr><td bgcolor="red">error status: 1 or 0</td></tr>
    </table>
  </li>
  <li>Loop:</li>
  <ul>
    <li>If sending a new query or re-executing a previously prepared query:</li>
    <ul>
      <li>Send:
        <ul>
          <li>If executing a new query:
            <table border="1">
            <tr><td bgcolor="red">0 (new query)</td></tr>
            <tr><td bgcolor="yellow">length of the query</td></tr>
            <tr><td bgcolor="green">the query string</td></tr>
            </table>
          </li>
          <li>If re-executing a previously prepared query:
            <table border="1">
            <tr><td bgcolor="red">13 (reexecute query)</td></tr>
            <tr><td bgcolor="red">cursor id</td></tr>
            </table>
          </li>
        </ul>
      </li>
      <table border="1">
      <tr><td bgcolor="red">The number of input bind variables</td></tr>
      </table>
      <ul>
        <li>For each input bind variable:
          <table border="1">
          <tr><td bgcolor="red">length of the bind variable name</td></tr>
          <tr><td bgcolor="green">the bind variable name string</td></tr>
          </table>
          <ul>
            <li>For a string variable:
              <table border="1">
              <tr><td bgcolor="red">1 (indicates that this is a string variable)</td></tr>
              <tr><td bgcolor="red">the size of the bind variable value</td></tr>
              <tr><td bgcolor="green">the bind variable value</td></tr>
              </table>
            </li>
            <li>For a long variable:
              <table border="1">
              <tr><td bgcolor="red">2 (indicates that this is a long variable)</td></tr>
              <tr><td bgcolor="yellow">the bind variable value</td></tr>
              </table>
            </li>
            <li>For a double variable:
              <table border="1">
              <tr><td bgcolor="red">3 (indicates that this is a long variable)</td></tr>
              <tr><td bgcolor="blue">the bind variable value</td></tr>
              <tr><td bgcolor="red">the bind variable precision</td></tr>
              <tr><td bgcolor="red">the bind variable scale</td></tr>
              </table>
            </li>
            <li>For a NULL variable:
              <table border="1">
              <tr><td bgcolor="red">0 (indicates that this is a NULL variable)</td></tr>
              </table>
            </li>
            <li>For a BLOB variable:
              <table border="1">
              <tr><td bgcolor="red">4 (indicates that this is a blob variable)</td></tr>
              <tr><td bgcolor="yellow">the size of the bind variable value</td></tr>
              <tr><td bgcolor="green">the bind variable value</td></tr>
              </table>
            </li>
            <li>For a CLOB variable:
              <table border="1">
              <tr><td bgcolor="red">5 (indicates that this is a blob variable)</td></tr>
              <tr><td bgcolor="yellow">the size of the bind variable value</td></tr>
              <tr><td bgcolor="green">the bind variable value</td></tr>
              </table>
            </li>
          </ul>
        </li>
      </ul>
      <table border="1">
      <tr><td bgcolor="red">The number of output bind variables</td></tr>
      </table>
      <ul>
        <li>For each output bind variable:
          <table border="1">
          <tr><td bgcolor="red">length of the bind variable name</td></tr>
          <tr><td bgcolor="green">the bind variable name string</td></tr>
          </table>
	  <ul>
            <li>For string/BLOB/CLOB output bind variables:
              <table border="1">
              <tr><td bgcolor="red">1 (indicates that this is a string/BLOB/CLOB variable)</td></tr>
              <tr><td bgcolor="red">the size of the bind variable value</td></tr>
              </table>
	    </li>
	    <li>For cursor output bind variables:
              <table border="1">
              <tr><td bgcolor="red">6 (indicates that this is a cursor variable)</td></tr>
              </table>
	    </li>
          </ul>
        </li>
      </ul>
      <ul>
        <li>If you want to get column info:
          <table border="1">
          <tr><td bgcolor="red">1</td></tr>
          </table>
        </li>
        <li>If you don't want to get column info:
          <table border="1">
          <tr><td bgcolor="red">0</td></tr>
          </table>
        </li>
      </ul>
      <table border="1">
      <tr><td bgcolor="yellow">The number of rows to skip</td></tr>
      <tr><td bgcolor="yellow">The number of rows to fetch</td></tr>
      </table>
      Skip to <a href="#receive">"If fetching rows from a result set: Receive"</a> below...
    </ul>
    <li>If fetching from a bind cursor
      <ul>
        <table border="1">
        <tr><td bgcolor="red">14 (fetch from bind cursor)</td></tr>
        <tr><td bgcolor="red">cursor id</td></tr>
        <tr><td bgcolor="red">0 (number of input binds)</td></tr>
        <tr><td bgcolor="red">0 (number of output binds)</td></tr>
        </table>
        <ul>
          <li>If you want to get column info:
            <table border="1">
            <tr><td bgcolor="red">1</td></tr>
            </table>
          </li>
          <li>If you don't want to get column info:
            <table border="1">
            <tr><td bgcolor="red">0</td></tr>
            </table>
          </li>
        </ul>
        <table border="1">
        <tr><td bgcolor="yellow">The number of rows to skip</td></tr>
        <tr><td bgcolor="yellow">The number of rows to fetch</td></tr>
        </table>
        Skip to <a href="#receive">"If fetching rows from a result set: Receive"</a> below...
      </ul>
    </li>
    <li>If sending a commit:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">9 (sending a commit)</td></tr>
          </table>
        </li>
        <li>Receive:
          <table border="1">
          <tr><td bgcolor="red">1 or 0</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If sending a rollback:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">10 (sending a rollback)</td></tr>
          </table>
        </li>
        <li>Receive:
          <table border="1">
          <tr><td bgcolor="red">1 or 0</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If toggling autocommit:
      <ul>
      <li>Send:
        <table border="1">
        <tr><td bgcolor="red">11 (autocommit)</td></tr>
        <tr><td bgcolor="red">0 to turn off autocommit and 1 to turn on autocommit</td></tr>
        </table>
        </li>
        <li>Receive:
          <table border="1">
          <tr><td bgcolor="red">1 if toggling autocommit succeeded and 0 if it failed</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If sending a ping:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">7 (sending a ping)</td></tr>
          </table>
        </li>
        <li>Receive:
          <table border="1">
          <tr><td bgcolor="red">1 or 0</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If sending a identify:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">8 (sending a identify)</td></tr>
          </table>
        </li>
        <li>Receive:
          <table border="1">
          <tr><td bgcolor="red">length of the id string</td></tr>
          <tr><td bgcolor="green">id string</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If fetching rows from a result set:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">1 (fetch rows from a result set)</td></tr>
          <tr><td bgcolor="red">the id of the cursor to fetch from</td></tr>
          <tr><td bgcolor="yellow">The number of rows to skip</td></tr>
          <tr><td bgcolor="yellow">The number of rows to fetch</td></tr>
          </table>
        </li>
        <a name="receive"></a>
        <li>Receive:
          <table border="1">
          <tr><td bgcolor="red">error status: 1 or 0</td></tr>
          </table>
        </li>
        <ul>
          <li>If error status is 1
            <table border="1">
            <tr><td bgcolor="red">length of the error</td></tr>
            <tr><td bgcolor="green">error string</td></tr>
            </table>
          </li>
          <li>If error status is 0
            <table border="1">
            <tr><td bgcolor="red">cursor id</td></tr>
            <tr><td bgcolor="red">whether result set was suspended or not: 1 or 0</td></tr>
            <tr><td bgcolor="red">whether the server knows the total number of rows or not: 1 or 0</td></tr>
            </table>
          </li>
          <ul>
            <li>If server knows the total number of rows:
              <table border="1">
              <tr><td bgcolor="red">total number of rows</td></tr>
              </table>
            </li>
          </ul>
          <table border="1">
          <tr><td bgcolor="red">whether the server knows the number of affected rows or not: 1 or 0</td></tr>
          </table>
          <ul>
            <li>If server knows the number of affected rows:
              <table border="1">
              <tr><td bgcolor="red">number of affected rows</td></tr>
              </table>
            </li>
          </ul>
          <table border="1">
          <tr><td bgcolor="red">whether the server is sending column info or not: 1 or 0</td></tr>
          <tr><td bgcolor="red">column count</td></tr>
          <tr><td bgcolor="red">whether the server is sending column types as strings or predefined id's: 1 or 0</td></tr>
          </table>
          <ul>
            <li>If server is sending column info:
              <ul>
                <li>For each column:
		  <ul>
		    <li>Column Name:
                      <table border="1">
                      <tr><td bgcolor="red">name length</td></tr>
                      <tr><td bgcolor="green">name</td></tr>
		      </table>
		    </li>
		    <li>Column Type:
		      <ul>
			<li>If server is sending column type id's:
                          <table border="1">
                          <tr><td bgcolor="red">type id</td></tr>
		          </table>
                        </li>
			<li>If server is sending column types as strings:
                          <table border="1">
                          <tr><td bgcolor="red">type string length</td></tr>
                          <tr><td bgcolor="green">type string</td></tr>
		          </table>
                        </li>
		      </ul>
		    </li>
		    <li>Column Sizes:
                      <table border="1">
                      <tr><td bgcolor="yellow">length</td></tr>
                      <tr><td bgcolor="yellow">precision</td></tr>
                      <tr><td bgcolor="yellow">scale</td></tr>
                      </table>
		    </li>
		    <li>Column Flags:
                      <table border="1">
                      <tr><td bgcolor="red">is nullable (1 or 0)</td></tr>
                      <tr><td bgcolor="red">is primary key (1 or 0)</td></tr>
                      <tr><td bgcolor="red">is unique (1 or 0)</td></tr>
                      </table>
		    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <ul>
            <li>Loop:
              <table border="1">
              <tr><td bgcolor="red">output bind variable type: 0,1,2,4 or 5</td></tr>
              </table>
              <ul>
                <li>If type is 0 then the data is null</li>
                <li>If type is 1 then the data is a string
                  <table border="1">
                  <tr><td bgcolor="red">output bind value length</td></tr>
                  <tr><td bgcolor="green">output bind value</td></tr>
                  </table>
                </li>
		<li>If type is 2 then the data is BLOB/CLOB data
		  <ul>
		    <li>Loop:
                      <table border="1">
                      <tr><td bgcolor="red">chunk type: 1 or 3</td></tr>
                      </table>
                      <ul>
                        <li>If type is 1 then chunk is string data
                          <table border="1">
                          <tr><td bgcolor="red">chunk length</td></tr>
                          <tr><td bgcolor="green">chunk data</td></tr>
                          </table>
                        </li>
                        <li>If type is 3 then break out of the loop</li>
                      </ul>
		    </li>
		  </ul>
		</li>
                <li>If type is 4 then the data is a cursor id
                  <table border="1">
                  <tr><td bgcolor="red">cursor id</td></tr>
                  </table>
                </li>
                <li>If type is 5 then break out of loop</li>
              </ul>
            </li>
          </ul>
        </ul>
        <li>Loop, Receiving:
          <table border="1">
          <tr><td bgcolor="red">field type: 0,1,2,3 or 4</td></tr>
          </table>
        </li>
        <ul>
          <li>If field type is 0 then the data is null</li>
          <li>If field type is 1 then the data is normal data
            <table border="1">
            <tr><td bgcolor="yellow">length of the data</td></tr>
            <tr><td bgcolor="green">the data</td></tr>
            </table>
          </li>
          <li>If field type is 2 then this is a chunk of long data
            <table border="1">
            <tr><td bgcolor="yellow">length of the chunk</td></tr>
            <tr><td bgcolor="green">the chunk</td></tr>
            </table>
          </li>
          <li>If field type is 3 then this is the end of the long data</li>
          <li>If field type is 4 (end of result set) then break out of the loop</li>
        </ul>
      </ul>
    </li>
    <li>If aborting a result set:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">2 (abort a result set)</td></tr>
          <tr><td bgcolor="red">the id of the cursor to abort</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If suspending a result set:
      <ul>
        <li>Send:
          <table border="1">
          <tr><td bgcolor="red">3 (suspend a result set)</td></tr>
          <tr><td bgcolor="red">the id of the cursor to suspend</td></tr>
          </table>
        </li>
      </ul>
    </li>
    <li>If resuming a previously suspended result set:
      <ul>
        <li>Send:
        <table border="1">
        <tr><td bgcolor="red">4 (resume a result set)</td></tr>
        <tr><td bgcolor="red">the id of the cursor to resume</td></tr>
        <tr><td bgcolor="yellow">The number of rows to skip</td></tr>
        <tr><td bgcolor="yellow">The number of rows to fetch</td></tr>
        </table>
        Skip to <a href="#receive">"If fetching rows from a result set: Receive"</a> above...
        </li>
      </ul>
    </li>
  </ul>
</ul>
    
</body>
</html>
