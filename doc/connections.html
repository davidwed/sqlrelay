<html>
<head>
<title>firstworks   SQL Relay Database Connection Daemons</title>
<link href="css/styles.css" rel="stylesheet">
</head>
<body>

<span class="heading1">SQL Relay Database Connection Daemons</span><br><br>

<p>Most database API's work like this:</p>

<ul>
<li>Initialize</li>
<li>Log into the database</li>
<li>Loop</li>
<ul>
<li>Execute a query</li>
<li>Get the result set column description</li>
<li>Loop</li>
<ul>
<li>Fetch a row</li>
<li>Manipulate the fields in the row</li>
</ul>
</ul>
<li>Log out</li>
<li>Clean up</li>
</ul>

<p>The <b>SQL Relay</b> connection daemon class works this way too.  Writing a 
connection daemon mainly consists of wrapping database API methods in 
corresponding connection class methods.  More specifically, to write a new 
connection daemon, you create classes which inherit from the "connection" 
and "cursor" classes and implement their pure virtual methods.</p>

<p>Below is an example.  On the left is pseudocode and on the right, the
code for the MySQL connection.</p>

<span class="heading2">Header File</span><br><br>
<table width="100%" border="1">
<tr>
<td valign="top">
<pre>
<FONT color=#0000f8>// Copyright (c) 2000-2001  David Muse</FONT>
<FONT color=#0000f8>// See the file COPYING for more information</FONT>

<FONT color=#a020f0>#ifndef MYCONNECTION_H</FONT>
<FONT color=#a020f0>#define MYCONNECTION_H</FONT>

<FONT color=#a020f0>#define NUM_CONNECT_STRING_VARS </FONT><FONT color=#f800f8>however many connect string vars you have</FONT>

<FONT color=#a020f0>#include </FONT><FONT color=#f800f8>&lt;connection.h&gt;</FONT>

<FONT color=#a020f0>#include </FONT><FONT color=#f800f8>&lt; whatever header files you need &gt;</FONT>

<FONT color=#a020f0>#include </FONT><FONT color=#f800f8>&lt; your header file &gt;</FONT>

<B><FONT color=#288850>class</FONT></B> myconnection;

<B><FONT color=#288850>class</FONT></B> mycursor : <B><FONT color=#a02828>public</FONT></B> cursor {
        <B><FONT color=#a02828>friend</FONT></B> <B><FONT color=#288850>class</FONT></B> myconnection;
        <B><FONT color=#a02828>private</FONT></B>:
                        mycursor(connection *conn);
                        ~mycursor();

		... override the cursor class's pure virtual methods ...

                <B><FONT color=#288850>int</FONT></B>     executeQuery(<B><FONT color=#288850>char</FONT></B> *query, <B><FONT color=#288850>long</FONT></B> length);
                <B><FONT color=#288850>char</FONT></B>    *getErrorMessage(<B><FONT color=#288850>int</FONT></B> *liveconnection);
                <B><FONT color=#288850>void</FONT></B>    returnRowCounts();
                <B><FONT color=#288850>void</FONT></B>    returnColumnCount();
                <B><FONT color=#288850>void</FONT></B>    returnColumnInfo();
                <B><FONT color=#288850>int</FONT></B>     noRowsToReturn();
                <B><FONT color=#288850>int</FONT></B>     skipRow();
                <B><FONT color=#288850>int</FONT></B>     fetchRow();
                <B><FONT color=#288850>void</FONT></B>    returnRow();
                <B><FONT color=#288850>void</FONT></B>    cleanUpData();

		... you'll need a result set descriptor
		    possibly some other descriptors ...

		... you'll probably need variables for
		    the number of rows, columns,
		    affected rows and an error message ...

		... and a pointer to the connection class ...
                myconnection *myconn;
};

<B><FONT color=#288850>class</FONT></B> myconnection : <B><FONT color=#a02828>public</FONT></B> connection {
        <B><FONT color=#a02828>friend</FONT></B> <B><FONT color=#288850>class</FONT></B> mycursor;
        <B><FONT color=#a02828>public</FONT></B>:
                        myconnection();
                        ~myconnection();
        <B><FONT color=#a02828>private</FONT></B>:

		... override the connection class's pure virtual methods ...

                <B><FONT color=#288850>int</FONT></B>             getNumberOfConnectStringVars();
                <B><FONT color=#288850>void</FONT></B>            handleConnectString();
                <B><FONT color=#288850>int</FONT></B>             logIn();
                cursor          *initCursor();
                <B><FONT color=#288850>void</FONT></B>            deleteCursor(cursor *curs);
                <B><FONT color=#288850>void</FONT></B>            logOut();
                <B><FONT color=#288850>int</FONT></B>             isTransactional();
                <B><FONT color=#288850>int</FONT></B>             ping();
                <B><FONT color=#288850>char</FONT></B>            *identify();
                <B><FONT color=#288850>unsigned short</FONT></B>  *autoCommitOn();
                <B><FONT color=#288850>unsigned short</FONT></B>  *autoCommitOff();
                <B><FONT color=#288850>void</FONT></B>            commit();
                <B><FONT color=#288850>void</FONT></B>            rollback();


		... you'll need a connection descriptor here ...

		... you'll also need variables for the 
		    connect string arguments ...
};

<FONT color=#a020f0>#endif</FONT>
</pre>
</td>
<td valign="top">
<pre>
<font color="#0000f8">// Copyright (c) 2000-2001  David Muse</font>
<font color="#0000f8">// See the file COPYING for more information</font>

<font color="#a020f0">#ifndef MYSQLCONNECTION_H</font>
<font color="#a020f0">#define MYSQLCONNECTION_H</font>

<font color="#a020f0">#define NUM_CONNECT_STRING_VARS </font><font color="#f800f8">6</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;sqlrconnection.h&gt;</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;mysql.h&gt;</font>

<font color="#288850"><b>class</b></font> mysqlconnection;

<font color="#288850"><b>class</b></font> mysqlcursor : <font color="#a02828"><b>public</b></font> sqlrcursor {
        <font color="#a02828"><b>friend</b></font> <font color="#288850"><b>class</b></font> mysqlconnection;
        <font color="#a02828"><b>private</b></font>:
                        mysqlcursor(sqlrconnection *conn);
                <font color="#288850"><b>int</b></font>     executeQuery(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *query, <font color="#288850"><b>long</b></font> length,
                                        <font color="#288850"><b>unsigned</b></font> <font color="#288850"><b>short</b></font> execute);
                <font color="#288850"><b>char</b></font>    *getErrorMessage(<font color="#288850"><b>int</b></font> *liveconnection);
                <font color="#288850"><b>void</b></font>    returnRowCounts();
                <font color="#288850"><b>void</b></font>    returnColumnCount();
                <font color="#288850"><b>void</b></font>    returnColumnInfo();
                <font color="#288850"><b>int</b></font>     noRowsToReturn();
                <font color="#288850"><b>int</b></font>     skipRow();
                <font color="#288850"><b>int</b></font>     fetchRow();
                <font color="#288850"><b>void</b></font>    returnRow();
                <font color="#288850"><b>void</b></font>    cleanUpData();

                MYSQL_RES       *mysqlresult;
                MYSQL_FIELD     *mysqlfield;
                MYSQL_ROW       mysqlrow;
                <font color="#288850"><b>int</b></font>             ncols;
                <font color="#288850"><b>int</b></font>             nrows;
                <font color="#288850"><b>int</b></font>             affectedrows;
                <font color="#288850"><b>int</b></font>             queryresult;

                mysqlconnection *mysqlconn;
};

<font color="#288850"><b>class</b></font> mysqlconnection : <font color="#a02828"><b>public</b></font> sqlrconnection {
        <font color="#a02828"><b>friend</b></font> <font color="#288850"><b>class</b></font> mysqlcursor;
        <font color="#a02828"><b>public</b></font>:
                        mysqlconnection();
        <font color="#a02828"><b>private</b></font>:
                <font color="#288850"><b>int</b></font>     getNumberOfConnectStringVars();
                <font color="#288850"><b>void</b></font>    handleConnectString();
                <font color="#288850"><b>int</b></font>     logIn();
                sqlrcursor      *initCursor();
                <font color="#288850"><b>void</b></font>    deleteCursor(sqlrcursor *curs);
                <font color="#288850"><b>void</b></font>    logOut();
                <font color="#288850"><b>int</b></font>     isTransactional();
<font color="#a020f0">#if MYSQL_VERSION_ID&gt;=</font><font color="#f800f8">32200</font>
                <font color="#288850"><b>int</b></font>     ping();
<font color="#a020f0">#endif</font>
                <font color="#288850"><b>char</b></font>    *identify();
                <font color="#288850"><b>unsigned</b></font> <font color="#288850"><b>short</b></font>  autoCommitOn();
                <font color="#288850"><b>unsigned</b></font> <font color="#288850"><b>short</b></font>  autoCommitOff();
                <font color="#288850"><b>int</b></font>     commit();
                <font color="#288850"><b>int</b></font>     rollback();

                MYSQL   mysql;
                <font color="#288850"><b>int</b></font>     connected;

                <font color="#288850"><b>char</b></font>    *db;
                <font color="#288850"><b>char</b></font>    *host;
                <font color="#288850"><b>char</b></font>    *port;
                <font color="#288850"><b>char</b></font>    *socket;
};

<font color="#a020f0">#endif</font>
</pre>
</td>
</tr>
</table>

<br><br>

<span class="heading2">.C File</span><br><br>
<table width="100%" border="1">
<tr>
<td valign="top">
<pre>
<FONT color=#0000f8>// Copyright (c) 1999-2001  Your Name Here</FONT>
<FONT color=#0000f8>// See the file COPYING for more information</FONT>

<FONT color=#a020f0>#include </FONT><FONT color=#f800f8>&lt; your header file &gt;</FONT>

	... you need to include this file too ...
<FONT color=#a020f0>#include </FONT><FONT color=#f800f8>&lt;datatypes.h&gt;</FONT>

	... you may need to include some other headers ...
</pre>
</td>
<td valign="top">
<pre>
<font color="#0000f8">// Copyright (c) 1999-2001  David Muse</font>
<font color="#0000f8">// See the file COPYING for more information</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;mysqlconnection.h&gt;</font>
<font color="#a020f0">#if MYSQL_VERSION_ID&gt;=</font><font color="#f800f8">32200</font>
<font color="#a020f0">        #include </font><font color="#f800f8">&lt;errmsg.h&gt;</font>
<font color="#a020f0">#endif</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;datatypes.h&gt;</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;config.h&gt;</font>

<font color="#a020f0">#include </font><font color="#f800f8">&lt;stdlib.h&gt;</font>
<font color="#a020f0">#include </font><font color="#f800f8">&lt;string.h&gt;</font>

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

myconnection::myconnection() {
        connected=<FONT color=#f800f8>0</FONT>;

	... initialize whatever you need to here ...
}

</pre>
</td>
<td valign="top">
<pre>

mysqlconnection::mysqlconnection() {
        connected=<font color="#f800f8">0</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

myconnection::~myconnection() {

	... deallocate whatever you initialized ...
}

</pre>
</td>
<td valign="top">
<pre>

	... the mysqlconnection has no destructor ...

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     myconnection::getNumberOfConnectStringVars() {
        <B><FONT color=#a02828>return</FONT></B> NUM_CONNECT_STRING_VARS;
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlconnection::getNumberOfConnectStringVars() {
        <font color="#a02828"><b>return</b></font> NUM_CONNECT_STRING_VARS;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    myconnection::handleConnectString() {

	... set your connect string variables 
            using the connectStringValue()
            method ...

}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlconnection::handleConnectString() {
        setUser(connectStringValue(<font color="#f800f8">&quot;user&quot;</font>));
        setPassword(connectStringValue(<font color="#f800f8">&quot;password&quot;</font>));
        db=connectStringValue(<font color="#f800f8">&quot;db&quot;</font>);
        host=connectStringValue(<font color="#f800f8">&quot;host&quot;</font>);
        port=connectStringValue(<font color="#f800f8">&quot;port&quot;</font>);
        socket=connectStringValue(<font color="#f800f8">&quot;socket&quot;</font>);
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     mysqlconnection::logIn() {

        ... set some default values for any
            missing connect string variables ...

        ... connect to the database ...

        ... return 1 for success, 0 for failure ...

}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlconnection::logIn() {


        <font color="#0000f8">// handle host</font>
        <font color="#288850"><b>char</b></font>    *hostval;
        <font color="#a02828"><b>if</b></font> (host &amp;&amp; host[<font color="#f800f8">0</font>]) {
                hostval=host;
        } <font color="#a02828"><b>else</b></font> {
                hostval=<font color="#f800f8">&quot;&quot;</font>;
        }

        <font color="#0000f8">// handle port</font>
        <font color="#288850"><b>int</b></font>     portval;
        <font color="#a02828"><b>if</b></font> (port &amp;&amp; port[<font color="#f800f8">0</font>]) {
                portval=atoi(port);
        } <font color="#a02828"><b>else</b></font> {
                portval=<font color="#f800f8">0</font>;
        }

        <font color="#0000f8">// handle socket</font>
        <font color="#288850"><b>char</b></font>    *socketval;
        <font color="#a02828"><b>if</b></font> (socket &amp;&amp; socket[<font color="#f800f8">0</font>]) {
                socketval=socket;
        } <font color="#a02828"><b>else</b></font> {
                socketval=<font color="#f800f8">NULL</font>;
        }

        <font color="#0000f8">// handle db</font>
        <font color="#288850"><b>char</b></font>    *dbval;
        <font color="#a02828"><b>if</b></font> (db &amp;&amp; db[<font color="#f800f8">0</font>]) {
                dbval=db;
        } <font color="#a02828"><b>else</b></font> {
                dbval=<font color="#f800f8">&quot;&quot;</font>;
        }

        <font color="#0000f8">// initialize database connection structure</font>
<font color="#a020f0">#if MYSQL_VERSION_ID&gt;=</font><font color="#f800f8">32200</font>
        <font color="#a02828"><b>if</b></font> (!mysql_init(&amp;mysql)) {
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
        }
<font color="#a020f0">#endif</font>

        <font color="#0000f8">// log in</font>
        <font color="#288850"><b>char</b></font>    *user=getUser();
        <font color="#288850"><b>char</b></font>    *password=getPassword();
<font color="#a020f0">#ifdef MYSQL_VERSION_ID</font>
<font color="#a020f0">        #if MYSQL_VERSION_ID&gt;=</font><font color="#f800f8">32200</font>
                <font color="#a02828"><b>if</b></font> (!mysql_real_connect(&amp;mysql,hostval,user,password,dbval,
                                                portval,socketval,<font color="#f800f8">0</font>)) {
<font color="#a020f0">        #else</font>
                <font color="#a02828"><b>if</b></font> (!mysql_real_connect(&amp;mysql,hostval,user,password,
                                                portval,socketval,<font color="#f800f8">0</font>)) {
<font color="#a020f0">        #endif</font>
<font color="#a020f0">#else</font>
        <font color="#a02828"><b>if</b></font> (!mysql_connect(&amp;mysql,hostval,user,password)) {
<font color="#a020f0">#endif</font>
                logOut();
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
        } <font color="#a02828"><b>else</b></font> {
<font color="#a020f0">#if MYSQL_VERSION_ID&lt;</font><font color="#f800f8">32200</font>
                <font color="#a02828"><b>if</b></font> (!mysql_select_db(&amp;mysql,dbval)) {
                        logOut();
                        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
                }
<font color="#a020f0">#endif</font>
                connected=<font color="#f800f8">1</font>;
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
        }
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

cursor  *myconnection::initCursor() {
        <B><FONT color=#a02828>return</FONT></B> (cursor *)<B><FONT color=#a02828>new</FONT></B> mycursor((connection *)<B><FONT color=#a02828>this</FONT></B>);
}

</pre>
</td>
<td valign="top">
<pre>

sqlrcursor      *mysqlconnection::initCursor() {
        <font color="#a02828"><b>return</b></font> (sqlrcursor *)<font color="#a02828"><b>new</b></font> mysqlcursor((sqlrconnection *)<font color="#a02828"><b>this</b></font>);
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    myconnection::deleteCursor(cursor *curs) {
        <B><FONT color=#a02828>delete</FONT></B> (mycursor *)curs;
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlconnection::deleteCursor(sqlrcursor *curs) {
        <font color="#a02828"><b>delete</b></font> (mysqlcursor *)curs;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    myconnection::logOut() {

	... disconnect from the database ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlconnection::logOut() {
        connected=<font color="#f800f8">0</font>;
        mysql_close(&amp;mysql);
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     myconnection::ping() {

	... test to see if the database connection
            is still good, return 1 if it is, and
            0 if it's not ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#a020f0">#if MYSQL_VERSION_ID&gt;=</font><font color="#f800f8">32200</font>
<font color="#288850"><b>int</b></font>     mysqlconnection::ping() {
        <font color="#a02828"><b>if</b></font> (!mysql_ping(&amp;mysql)) {
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
        }
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
}
<font color="#a020f0">#endif</font>

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>char</FONT></B>    *myconnection::identify() {

	... return the name of your database ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>char</b></font>    *mysqlconnection::identify() {
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">&quot;mysql&quot;</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     myconnection::isTransactional() {

	... you only need this method if your
            database is not transactional ...

        ... return a 0 ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlconnection::isTransactional() {
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>unsigned short</FONT></B>    myconnection::autoCommmitOn() {

	... set autocommit on ...

	... return 1 for success and 0 for failure ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>unsigned</b></font> <font color="#288850"><b>short</b></font>  mysqlconnection::autoCommitOn() {
        <font color="#0000f8">// do nothing</font>
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>unsigned short</FONT></B>    myconnection::autoCommmitOff() {

	... set autocommit off ...

	... return 1 for success and 0 for failure ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>unsigned</b></font> <font color="#288850"><b>short</b></font>  mysqlconnection::autoCommitOff() {
        <font color="#0000f8">// do nothing</font>
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>     myconnection::commit() {

	... if your database has a special commit 
	    function, call it here ...

	... if your database is non-transactional,
	    make this function do nothing ...

        ... if your database is transactional but
            doesn't have a special commit function,
            don't even implement this method at all,
	    let the base class provide it ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlconnection::commit() {
        <font color="#0000f8">// do nothing</font>
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>     myconnection::rollback() {

	... if your database has a special rollback 
	    function, call it here ...

	... if your database is non-transactional,
	    make this function do nothing ...

        ... if your database is transactional but
            doesn't have a special rollback function,
            don't even implement this method at all,
	    let the base class provide it ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlconnection::rollback() {
        <font color="#0000f8">// do nothing</font>
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

mycursor::mycursor(connection *conn) : cursor(conn) {

        mysqlconn=(mysqlconnection *)conn;
        errmesg=<FONT color=#f800f8>NULL</FONT>;

	... initialize whatever you need to here ...
}

</pre>
</td>
<td valign="top">
<pre>

mysqlcursor::mysqlcursor(sqlrconnection *conn) : sqlrcursor(conn) {
        mysqlconn=(mysqlconnection *)conn;
        mysqlresult=<font color="#f800f8">NULL</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

mycursor::~mycursor() {

	... deallocate whatever you initialized ...
}

</pre>
</td>
<td valign="top">
<pre>

	... the mysqlcursor has no destructor ...

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     mycursor::executeQuery(<B><FONT color=#288850>char</FONT></B> *query, <B><FONT color=#288850>long</FONT></B> length) {

	... check for a query that creates a temporary
	    table if your database supports them ...

	... set row and column counts to 0 ...

        Note: Some databases have a 3 step query
              execution process involving bind variables.
              See the information at the end of this
              document for how to handle those
              databases.

	... if your database doesn't support real
	    binds, then create a strstream buffer,
	    call fakeInputBinds() and pass the
	    result into your execute query command
	    (unless the result is NULL which means
	    there were no variables to bind in which
	    case you must execute the original query) ...

        ... get the result set ...

        ... get information about the result set 
            such as the row and column counts
            and the number of affected rows 
            (affected rows are the number of rows
            affected by an insert, update or delete) ...

        ... return 1 for success, 0 for failure ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlcursor::executeQuery(<font color="#288850"><b>const</b></font> <font color="#288850"><b>char</b></font> *query, <font color="#288850"><b>long</b></font> length,
                                                <font color="#288850"><b>unsigned</b></font> <font color="#288850"><b>short</b></font> execute) {

        checkForTempTable(query,length);

        <font color="#0000f8">// initialize counts</font>
        ncols=<font color="#f800f8">0</font>;
        nrows=<font color="#f800f8">0</font>;

        <font color="#0000f8">// initialize result set</font>
        mysqlresult=<font color="#f800f8">NULL</font>;

        <font color="#0000f8">// fake binds</font>
        stringbuffer    *newquery=fakeInputBinds(query);

        <font color="#0000f8">// execute the query</font>
        <font color="#a02828"><b>if</b></font> (newquery) {
                <font color="#a02828"><b>if</b></font> (queryresult=mysql_real_query(&amp;mysqlconn-&gt;mysql,
                                        newquery-&gt;getString(),
                                        strlen(newquery-&gt;getString()))) {
                        <font color="#a02828"><b>delete</b></font> newquery;
                        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
                }
                <font color="#a02828"><b>delete</b></font> newquery;
        } <font color="#a02828"><b>else</b></font> {
                <font color="#a02828"><b>if</b></font> (queryresult=mysql_real_query(&amp;mysqlconn-&gt;mysql,
                                                        query,length)) {
                        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
                }
        }

        <font color="#0000f8">// get the affected row count</font>
        affectedrows=mysql_affected_rows(&amp;mysqlconn-&gt;mysql);

        <font color="#0000f8">// store the result set</font>
        <font color="#a02828"><b>if</b></font> ((mysqlresult=mysql_store_result(&amp;mysqlconn-&gt;mysql))==
                                                (MYSQL_RES *)<font color="#f800f8">NULL</font>) {

                <font color="#0000f8">// if there was an error then return failure, otherwise</font>
                <font color="#0000f8">// the query must have been some DML or DDL</font>
                <font color="#288850"><b>char</b></font>    *err=mysql_error(&amp;mysqlconn-&gt;mysql);
                <font color="#a02828"><b>if</b></font> (err &amp;&amp; err[<font color="#f800f8">0</font>]) {
                        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
                } <font color="#a02828"><b>else</b></font> {
                        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
                }
        }

        <font color="#0000f8">// get the column count</font>
        ncols=mysql_num_fields(mysqlresult);

        <font color="#0000f8">// get the row count</font>
        nrows=mysql_num_rows(mysqlresult);

        <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>char</FONT></B>    *mycursor::getErrorMessage(<B><FONT color=#288850>int</FONT></B> *liveconnection) {

	... call the database API to get an error message ...

        ... if that error is a down database, set the
            "liveconnection" parameter to 1 ...

        ... return the error message string ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>char</b></font>    *mysqlcursor::getErrorMessage(<font color="#288850"><b>int</b></font> *liveconnection) {

        *liveconnection=<font color="#f800f8">1</font>;
        <font color="#288850"><b>char</b></font>    *err=mysql_error(&amp;mysqlconn-&gt;mysql);
<font color="#a020f0">#if MYSQL_VERSION_ID&gt;=</font><font color="#f800f8">32200</font>
        <font color="#a02828"><b>if</b></font> (queryresult==CR_SERVER_GONE_ERROR || queryresult==CR_SERVER_LOST) {
                *liveconnection=<font color="#f800f8">0</font>;
        }
<font color="#a020f0">#else</font>
        <font color="#a02828"><b>if</b></font> (strstr(err,<font color="#f800f8">&quot;mysql server has gone away&quot;</font>)) {
                *liveconnection=<font color="#f800f8">0</font>;
        }
<font color="#a020f0">#endif</font>
        <font color="#a02828"><b>return</b></font> err;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    mycursor::returnColumnCount() {

	... use the sendColumnCount() method to 
	    return the number of columns in the result set...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlcursor::returnColumnCount() {
        conn-&gt;sendColumnCount(ncols);
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    mycursor::returnRowCounts() {

	... use the sendRowCounts() method to return the 
	    number of rows and/or affected rows in the result set...

	... if your database api doesn't supply one or both
	    of these values, return -1 for whichever it doesn't
	    supply ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlcursor::returnRowCounts() {

        <font color="#0000f8">// send row counts</font>
        conn-&gt;sendRowCounts((<font color="#288850"><b>long</b></font>)nrows,(<font color="#288850"><b>long</b></font>)affectedrows);
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    mycursor::returnColumnInfo() {

	... It is possible to send back column types as strings or
	    id's.  Using id's is faster and preferred, however
	    if your database requires users to define their own
	    column types and has no built-in types, you can return
	    strings instead. ...

        ... if the query isn't a select, return immediately ...

        ... Position yourself at the first column.
            This is important because returnColumnInfo()
            may be called more than 1 time per result
            set (if the user suspends the result set
            for example) and you don't want to be
            off the end of the column list from the
            previous call.  Some database API's provide
            methods for accessing the columns by index
            or require you to store the definitions
            in your own array.  For those databases, 
            this positioning is not necessary. ...

        ... Run through the columns of the result set, 
            for each, use the sendColumnDefinition()
	    (or sendColumnDefinitionString()) method
	    to return the name, type and size of each.
	    When using sendColumnDefinition(), the
	    column type should be one of the types in
	    the datatypes.h file, so you'll have to
	    establish a mapping between one of them and
	    the database API's data types.  If your
	    database has a type that's not in that file,
	    add it and submit a patch! ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlcursor::returnColumnInfo() {

        conn-&gt;sendColumnTypeFormat(COLUMN_TYPE_IDS);

        <font color="#0000f8">// for DML or DDL queries, return no column info</font>
        <font color="#a02828"><b>if</b></font> (!mysqlresult) {
                <font color="#a02828"><b>return</b></font>;
        }

        <font color="#0000ff">// some useful variables</font>
        <font color="#2e8b57"><b>int</b></font>     type;
        <font color="#2e8b57"><b>int</b></font>     length;

        <font color="#0000ff">// position ourselves at the first field</font>
        mysql_field_seek(mysqlresult,<font color="#ff00ff">0</font>);

        <font color="#0000ff">// for each column...</font>
        <font color="#a52a2a"><b>for</b></font> (<font color="#2e8b57"><b>int</b></font> i=<font color="#ff00ff">0</font>; i&lt;ncols; i++) {

                <font color="#0000ff">// fetch the field</font>
                mysqlfield=mysql_fetch_field(mysqlresult);

                <font color="#0000ff">// append column type to the header</font>
                <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_STRING) {
                        type=STRING_DATATYPE;
                        length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_VAR_STRING) {
                        type=CHAR_DATATYPE;
                        length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">1</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_DECIMAL) {
                        type=DECIMAL_DATATYPE;
                        <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;decimals&gt;<font color="#ff00ff">0</font>) {
                                length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">2</font>;
                        } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;decimals==<font color="#ff00ff">0</font>) {
                                length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">1</font>;
                        }
                        <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;length&lt;mysqlfield-&gt;decimals) {
                                length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;decimals+<font color="#ff00ff">2</font>;
                        }
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_TINY) {
                        type=TINYINT_DATATYPE;
                        length=<font color="#ff00ff">1</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_SHORT) {
                        type=SMALLINT_DATATYPE;
                        length=<font color="#ff00ff">2</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_LONG) {
                        type=INT_DATATYPE;
                        length=<font color="#ff00ff">4</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_FLOAT) {
                        type=FLOAT_DATATYPE;
                        <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;length&lt;=<font color="#ff00ff">24</font>) {
                                length=<font color="#ff00ff">4</font>;
                        } <font color="#a52a2a"><b>else</b></font> {
                                length=<font color="#ff00ff">8</font>;
                        }
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_DOUBLE) {
                        type=REAL_DATATYPE;
                        length=<font color="#ff00ff">8</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_LONGLONG) {
                        type=BIGINT_DATATYPE;
                        length=<font color="#ff00ff">8</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_INT24) {
                        type=MEDIUMINT_DATATYPE;
                        length=<font color="#ff00ff">3</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_TIMESTAMP) {
                        type=TIMESTAMP_DATATYPE;
                        length=<font color="#ff00ff">4</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_DATE) {
                        type=DATE_DATATYPE;
                        length=<font color="#ff00ff">3</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_TIME) {
                        type=TIME_DATATYPE;
                        length=<font color="#ff00ff">3</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_DATETIME) {
                        type=DATETIME_DATATYPE;
                        length=<font color="#ff00ff">8</font>;
<font color="#a020f0">#if MYSQL_VERSION_ID&gt;=</font><font color="#ff00ff">32200</font>
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_YEAR) {
                        type=YEAR_DATATYPE;
                        length=<font color="#ff00ff">1</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_NEWDATE) {
                        type=NEWDATE_DATATYPE;
                        length=<font color="#ff00ff">1</font>;
<font color="#a020f0">#endif</font>
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_NULL) {
                        type=NULL_DATATYPE;
<font color="#a020f0">#ifdef MYSQL_VERSION_ID</font>
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_ENUM) {
                        type=ENUM_DATATYPE;
                        <font color="#0000ff">// 1 or 2 bytes delepending on the # of enum values</font>
                        <font color="#0000ff">// (65535 max)</font>
                        length=<font color="#ff00ff">2</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_SET) {
                        type=SET_DATATYPE;
                        <font color="#0000ff">// 1,2,3,4 or 8 bytes delepending on the # of members</font>
                        <font color="#0000ff">// (64 max)</font>
                        length=<font color="#ff00ff">8</font>;
<font color="#a020f0">#endif</font>
                <font color="#0000ff">// For some reason, tinyblobs, mediumblobs and longblobs</font>
                <font color="#0000ff">// all show up as FIELD_TYPE_BLOB despite field types being</font>
                <font color="#0000ff">// defined for those types.  tinyblobs have a length</font>
                <font color="#0000ff">// of 255 though, so that can be used for something.  medium</font>
                <font color="#0000ff">// and long blobs both have the same length though.  Go</font>
                <font color="#0000ff">// figure.  Also, the word TEXT and BLOB appear to be</font>
                <font color="#0000ff">// interchangable.  We'll use BLOB because it appears to be</font>
                <font color="#0000ff">// more standard than TEXT.  I wonder if this will be changed</font>
                <font color="#0000ff">// in a future incarnation of mysql.  I also wonder what</font>
                <font color="#0000ff">// happens on a 64 bit machine.</font>
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_TINY_BLOB) {
                        type=TINY_BLOB_DATATYPE;
                        length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">2</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_MEDIUM_BLOB) {
                        type=MEDIUM_BLOB_DATATYPE;
                        length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">3</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_LONG_BLOB) {
                        type=LONG_BLOB_DATATYPE;
                        length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">4</font>;
                } <font color="#a52a2a"><b>else</b></font> <font color="#a52a2a"><b>if</b></font> (mysqlfield-&gt;type==FIELD_TYPE_BLOB) {
                        <font color="#a52a2a"><b>if</b></font> ((<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length==<font color="#ff00ff">255</font>) {
                                type=TINY_BLOB_DATATYPE;
                                length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">2</font>;
                        } <font color="#a52a2a"><b>else</b></font> {
                                type=BLOB_DATATYPE;
                                length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length+<font color="#ff00ff">3</font>;
                        }
                } <font color="#a52a2a"><b>else</b></font> {
                        type=UNKNOWN_DATATYPE;
                        length=(<font color="#2e8b57"><b>int</b></font>)mysqlfield-&gt;length;
                }

                <font color="#0000ff">// send column definition</font>
                <font color="#0000ff">// for mysql, length is actually precision</font>
                conn-&gt;sendColumnDefinition(mysqlfield-&gt;name,
                                        strlen(mysqlfield-&gt;name),
                                        type,length,
                                        mysqlfield-&gt;length,
                                        mysqlfield-&gt;decimals,
                                        !(IS_NOT_NULL(mysqlfield-&gt;flags)),
                                        IS_PRI_KEY(mysqlfield-&gt;flags),<font color="#ff00ff">0</font>);
        }
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     mycursor::noRowsToReturn() {

	... test to see if you're at the end of the
            result set, if so, return 1, otherwise
            return 0 ...

        ... if there is no good way to know this
	    for your database, just return 0 ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlcursor::noRowsToReturn() {

        <font color="#0000f8">// for DML or DDL queries, return no data</font>
        <font color="#a02828"><b>if</b></font> (!mysqlresult) {
                <font color="#a02828"><b>return</b></font> <font color="#f800f8">1</font>;
        }
        <font color="#a02828"><b>return</b></font> <font color="#f800f8">0</font>;
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     mycursor::skipRow() {

	... If your API can skip rows in the result set without
	    actually fetching them, then do that here.  If not
	    just call fetchRow() ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlcursor::skipRow() {
        <font color="#a02828"><b>return</b></font> fetchRow();
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>int</FONT></B>     mycursor::fetchRow() {

	... fetch a row, return a 1 for success and 0 for failure ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>int</b></font>     mysqlcursor::fetchRow() {

        <font color="#a02828"><b>return</b></font> ((mysqlrow=mysql_fetch_row(mysqlresult))!=<font color="#f800f8">NULL</font>);
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    mycursor::returnRow() {

	... run through each column of the result 
            set and return it using the sendField()
            method ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlcursor::returnRow() {

        <font color="#a02828"><b>for</b></font> (<font color="#288850"><b>int</b></font> col=<font color="#f800f8">0</font>; col&lt;ncols; col++) {

                <font color="#a02828"><b>if</b></font> (mysqlrow[col]) {
                        conn-&gt;sendField(mysqlrow[col],strlen(mysqlrow[col]));
                } <font color="#a02828"><b>else</b></font> {
                        conn-&gt;sendNullField();
                }
        }
}

</pre>
</td>
</tr>
<tr>
<td valign="top">
<pre>

<B><FONT color=#288850>void</FONT></B>    mycursor::cleanUpData() {

	... if you allocated any memory between
            getting the query and returning the
            result set, deallocate it here ...

	... Note, this method shouldn't arbitrarily
	    deallocate memory.  It is possible that
	    it might be called before the first
	    query has been run, after a query failed
	    to run, etc. ...
}

</pre>
</td>
<td valign="top">
<pre>

<font color="#288850"><b>void</b></font>    mysqlcursor::cleanUpData() {
        <font color="#a02828"><b>if</b></font> (mysqlresult!=(MYSQL_RES *)<font color="#f800f8">NULL</font>) {
                mysql_free_result(mysqlresult);
                mysqlresult=<font color="#f800f8">NULL</font>;
        }
}
</pre>
</td>
</tr>
</table>

<p>If your database has a lightweight facility for switching from one user to 
another without just logging out and logging back in as a different user,
you should consider overriding the <code>changeUser()</code> method.</p>

<p>You may elect to override some more of the cursor class's virtual methods
as well.</p>

<p>When a session is ended (either on purpose or accident) the connection
daemon sends either a commit or rollback (depending on how it's configured)
to the database if any DML or DDL queries were executed.  The following
methods are used to implement this functionality.</p>

<ul>
<li><code>int queryIsNotSelect()</code>
<li><code>int queryIsCommitOrRollback()</code>
</ul>

<p>The queryIsNotSelect() method returns 0 if the query is a SELECT and 1 
if it is not.  Similarly, the queryIsCommitOrRollback() method returns 1 if the
query is either a COMMIT or ROLLBACK and 0 if it is not.  The connection class
implements these methods by parsing the text of the query.  Many database 
API's have their own means of identifying the query type.  If yours does, then 
you should use it to override these methods.</p>

<p>Some databases have a 3 part process for executing queries or 
procedural code. In Part 1, the database figures out what steps it will take to
run the query or code.  In Part 2, local variables or values are "bound" to 
variables in those steps.  In Part 3, the steps are executed.  If your 
database has a process like this, you should override these methods.

<ul>
<li><code>int prepareQuery()</code>
<li><code>int inputBindValue()</code>
<li><code>int outputBindValue()</code>
<li><code>int bindVariablePrefix()</code>
<li><code>int nullBindValue()</code>
<li><code>int nonNullBindValue()</code>
<li><code>int bindValueIsNull()</code>
</ul>

<p>The prepareQuery() method should execute Part 1 functions.  The 
inputBindValue() and outputBindValue() methods should handle functions for 
Part 2.  And the executeQuery() method should handle Part 3.</p>

<p>If your database uses a character other than a colon as a prefix for it's
named bind variables, then you should override the bindVariablePrefix() method
to return that character.  Similarly, if your database uses a value other
than 0 in it's bind functions to indicate that a value is NULL and a value 
other than -1 to indicate that a value is non-NULL then you should override
the nullBindValue() and nonNullBindValue() methods to return the appropriate
values.  You should also override the bindValueIsNull() method to return
0 if the value passed into it corresponds to your non-NULL indicator and 1 if
the value passed into it corresponds to your NULL indicator.</p> 

<p>If your database API has a function for determining whether the database
is up or down (a ping method) then you should implement the ping() method.  The
example MySQL connection does this.  However, if your database has no such
method, the connection class can run a simple query and check for a "database
is down" error.  You can specify a query to run by implementing the pingQuery()
method instead of the ping() method.</p>

</body>
</html>
